{% extends "base.html" %}

{% block title %}Query PACS - DICOM Fabricator{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-search"></i> Query PACS</h2>
        <p class="text-muted">Search and query DICOM studies on PACS servers</p>
    </div>
</div>

<!-- Query Form -->
<div class="row mb-3">
    <div class="col-xl-9">
        <div class="card">
            <div class="card-header py-2">
                <h6 class="mb-0"><i class="fas fa-search"></i> Query PACS</h6>
            </div>
            <div class="card-body py-3">
                <form id="pacsQueryForm">
                    <div class="row mb-2">
                        <div class="col-md-6">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <label for="queryPacsSelect" class="form-label small mb-0">Select PACS</label>
                                <div class="btn-group btn-group-sm" role="group" aria-label="Environment filter">
                                    <input type="radio" class="btn-check" name="envFilter" id="envTest" value="test" checked>
                                    <label class="btn btn-outline-success btn-sm" for="envTest">Test</label>
                                    
                                    <input type="radio" class="btn-check" name="envFilter" id="envProd" value="prod">
                                    <label class="btn btn-outline-primary btn-sm" for="envProd">Prod</label>
                                    
                                    <input type="radio" class="btn-check" name="envFilter" id="envBoth" value="both">
                                    <label class="btn btn-outline-secondary btn-sm" for="envBoth">Both</label>
                                </div>
                            </div>
                            <select id="queryPacsSelect" class="form-select form-select-sm" multiple>
                                <option value="">Loading...</option>
                            </select>
                            <div id="selectedPacsHint" class="form-text mt-1" style="display: none; font-size: 0.75rem;">
                                <i class="fas fa-info-circle"></i> <span id="selectedPacsText"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="daysAgo" class="form-label small mb-1">Date Range</label>
                            <select id="daysAgo" class="form-select form-select-sm">
                                <option value="0">All dates</option>
                                <option value="1">Last 1 day</option>
                                <option value="7">Last 7 days</option>
                                <option value="30">Last 30 days</option>
                                <option value="90">Last 90 days</option>
                                <option value="365">Last year</option>
                            </select>
                            
                            <label for="maxResults" class="form-label small mb-1 mt-2">
                                Max Results per PACS 
                                <i class="fas fa-info-circle text-muted" data-bs-toggle="tooltip" 
                                   data-bs-placement="top" 
                                   title="Maximum number of studies to return from each PACS server. Uses DICOM C-CANCEL to limit results, but some PACS servers may return more results than requested due to network buffering, query optimization, or incomplete C-CANCEL support."></i>
                            </label>
                            <input type="number" id="maxResults" class="form-control form-control-sm" value="100" min="1" max="1000" 
                                   title="Maximum number of studies to return from each PACS server (1-1000)">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-2">
                                <label for="patientNameQuery" class="form-label small mb-1">Patient Name</label>
                                <input type="text" class="form-control form-control-sm" id="patientNameQuery" 
                                       placeholder="e.g., SMITH^JOHN or *SMITH*">
                                <div class="form-text small">Supports wildcards: * and ?</div>
                            </div>
                            
                            <div class="mb-2">
                                <label for="patientIdQuery" class="form-label small mb-1">Patient ID</label>
                                <input type="text" class="form-control form-control-sm" id="patientIdQuery" 
                                       placeholder="e.g., PID12345">
                            </div>
                            
                            <div class="mb-2">
                                <label for="accessionQuery" class="form-label small mb-1">Accession Number</label>
                                <input type="text" class="form-control form-control-sm" id="accessionQuery" 
                                       placeholder="e.g., ACC001">
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-2">
                                <label for="studyUidQuery" class="form-label small mb-1">Study Instance UID</label>
                                <input type="text" class="form-control form-control-sm" id="studyUidQuery" 
                                       placeholder="e.g., 1.2.826.0.1.3680043.8.498.1...">
                            </div>
                            
                            <div class="mb-2">
                                <label for="seriesUidQuery" class="form-label small mb-1">Series Instance UID</label>
                                <input type="text" class="form-control form-control-sm" id="seriesUidQuery" 
                                       placeholder="e.g., 1.2.826.0.1.3680043.8.498.2...">
                                <div class="form-text small">Will switch to series-level query</div>
                            </div>
                            
                            <div class="alert alert-info mb-0 py-2" style="font-size: 0.8rem;">
                                <i class="fas fa-info-circle"></i>
                                <strong>Tips:</strong> Leave fields empty to search all values. 
                                Use wildcards (*) for partial matches. Combine criteria to narrow results.
                                <br><small>Note: Max results limit applies to each PACS server individually.</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-2">
                        <div class="col-12 text-end">
                            <button type="submit" class="btn btn-primary btn-sm">
                                <i class="fas fa-search"></i> Query PACS
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="fas fa-terminal"></i> DICOM Command Log</h6>
                <button class="btn btn-outline-secondary btn-sm" onclick="clearCommandLog()" 
                        title="Clear log" data-bs-toggle="tooltip">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            <div class="card-body p-2" style="height: 400px; overflow-y: auto;" id="commandLogContainer">
                <div id="commandLog" class="font-monospace text-muted" style="font-size: 0.65rem; line-height: 1.1;">
                    <div class="text-center py-4">
                        <i class="fas fa-terminal fa-2x mb-2 opacity-50"></i>
                        <div>DICOM command output will appear here</div>
                        <small class="text-muted">Run a query to see command logs</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Query Results Section -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-table"></i> Query Results</h5>
                <button class="btn btn-outline-primary btn-sm" onclick="exportResults()" 
                        id="exportBtn" style="display: none;">
                    <i class="fas fa-download"></i> Export CSV
                </button>
            </div>
            <div class="card-body">
                <div id="queryResults">
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-search fa-3x mb-3 opacity-25"></i>
                        <h5>No Query Results</h5>
                        <p>Use the query form above to search for DICOM studies</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- C-MOVE PACS Selection Modal -->
<div class="modal fade" id="cMoveModal" tabindex="-1" aria-labelledby="cMoveModalLabel" aria-hidden="true" 
     style="z-index: 1070;" data-bs-backdrop="true" data-bs-keyboard="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cMoveModalLabel">
                    <i class="fas fa-exchange-alt"></i> C-MOVE Study
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">Select one or more destination PACS servers to move this study to:</p>
                
                <!-- Environment Filter -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <label for="cMovePacsSelect" class="form-label small mb-0">Select Destination PACS</label>
                        <div class="btn-group btn-group-sm" role="group" aria-label="Environment filter">
                            <input type="radio" class="btn-check" name="cMoveEnvFilter" id="cMoveEnvTest" value="test" checked>
                            <label class="btn btn-outline-success btn-sm" for="cMoveEnvTest">Test</label>
                            
                            <input type="radio" class="btn-check" name="cMoveEnvFilter" id="cMoveEnvProd" value="prod">
                            <label class="btn btn-outline-primary btn-sm" for="cMoveEnvProd">Prod</label>
                            
                            <input type="radio" class="btn-check" name="cMoveEnvFilter" id="cMoveEnvBoth" value="both">
                            <label class="btn btn-outline-secondary btn-sm" for="cMoveEnvBoth">Both</label>
                        </div>
                    </div>
                    <select id="cMovePacsSelect" class="form-select form-select-sm" multiple>
                        <option value="">Loading...</option>
                    </select>
                    <div id="cMoveSelectedPacsHint" class="form-text mt-1" style="display: none; font-size: 0.75rem;">
                        <i class="fas fa-info-circle"></i> <span id="cMoveSelectedPacsText"></span>
                    </div>
                </div>
                
                <div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle"></i>
                    <strong>Study to Move:</strong>
                    <br>
                    <span id="cMoveStudyInfo">-</span>
                </div>
                
                <div class="alert alert-warning mb-0">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Note:</strong> C-MOVE will retrieve the study from the source PACS and store it on the destination PACS. 
                    This operation may take time depending on the study size and network conditions.
                    <br><small>If multiple PACS are selected, C-MOVE operations will be performed sequentially.</small>
                    <br><small><strong>Important:</strong> C-MOVE requires the source PACS to be configured to send to the destination PACS. If C-MOVE fails, consider using the Study Operations modal to directly send (C-STORE) the study to the destination PACS.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="cMoveExecuteBtn" onclick="executeCMove()" disabled>
                    <i class="fas fa-exchange-alt"></i> C-MOVE
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Study Details Modal -->
<div class="modal fade" id="studyDetailsModal" tabindex="-1" aria-labelledby="studyDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="studyDetailsModalLabel">
                    <i class="fas fa-info-circle"></i> Study Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="studyDetailsContent">
                <!-- Content will be dynamically populated -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-sm btn-primary" onclick="showCMoveDialog()">
                    <i class="fas fa-exchange-alt"></i> C-MOVE this study to...
                </button>
                <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
// Custom table implementation for query results
class CustomTable {
    constructor(selector, options = {}) {
        this.table = document.querySelector(selector);
        this.options = options;
        this.data = [];
        this.currentSort = { column: null, direction: 'asc' };
        
        if (this.table) {
            this.init();
        }
    }
    
    init() {
        // Add custom table class
        this.table.classList.add('custom-table');
        
        // Make headers sortable
        const headers = this.table.querySelectorAll('th');
        headers.forEach((header, index) => {
            if (header.textContent.trim() !== '') {
                header.classList.add('sortable');
                header.style.cursor = 'pointer';
                header.addEventListener('click', () => this.sortByColumn(index));
            }
        });
    }
    
    sortByColumn(columnIndex) {
        const headers = this.table.querySelectorAll('th');
        const header = headers[columnIndex];
        
        // Clear previous sort indicators
        headers.forEach(h => {
            h.classList.remove('sort-asc', 'sort-desc');
        });
        
        // Determine sort direction
        if (this.currentSort.column === columnIndex) {
            this.currentSort.direction = this.currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
            this.currentSort.column = columnIndex;
            this.currentSort.direction = 'asc';
        }
        
        // Add sort indicator
        header.classList.add(`sort-${this.currentSort.direction}`);
        
        // Sort the table
        this.sortTable(columnIndex, this.currentSort.direction);
    }
    
    sortTable(columnIndex, direction) {
        const tbody = this.table.querySelector('tbody');
        if (!tbody) return;
        
        const rows = Array.from(tbody.querySelectorAll('tr'));
        
        rows.sort((a, b) => {
            const aCell = a.cells[columnIndex];
            const bCell = b.cells[columnIndex];
            
            if (!aCell || !bCell) return 0;
            
            let aValue = aCell.textContent.trim();
            let bValue = bCell.textContent.trim();
            
            // Handle special cases like badges and buttons
            if (aCell.querySelector('.badge')) {
                aValue = aCell.querySelector('.badge').textContent.trim();
            }
            if (bCell.querySelector('.badge')) {
                bValue = bCell.querySelector('.badge').textContent.trim();
            }
            
            // Try to convert to numbers for numeric sorting
            const aNum = parseFloat(aValue);
            const bNum = parseFloat(bValue);
            
            if (!isNaN(aNum) && !isNaN(bNum)) {
                return direction === 'asc' ? aNum - bNum : bNum - aNum;
            }
            
            // String sorting
            if (direction === 'asc') {
                return aValue.localeCompare(bValue);
            } else {
                return bValue.localeCompare(aValue);
            }
        });
        
        // Reorder rows
        rows.forEach(row => tbody.appendChild(row));
    }
    
    setData(data) {
        this.data = data;
        console.log('Query results table data set:', data.length, 'rows');
    }
    
    refresh() {
        console.log('Query results table refreshed');
    }
    
    destroy() {
        // Clean up event listeners
        const headers = this.table.querySelectorAll('th');
        headers.forEach(header => {
            header.classList.remove('sortable', 'sort-asc', 'sort-desc');
            header.style.cursor = '';
        });
        this.table.classList.remove('custom-table');
    }
}

let currentResults = [];
let currentQueryInfo = {};
let currentStudyForCMove = null;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Initialize environment filter first
    initializeEnvironmentFilter();
    
    // Then load PACS configs
    loadPacsConfigs();
    
    // Initialize form submission
    document.getElementById('pacsQueryForm').addEventListener('submit', function(e) {
        e.preventDefault();
        queryPacs();
    });
    
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

function initializeEnvironmentFilter() {
    // Load saved environment preference
    const savedEnv = localStorage.getItem('pacs-environment-filter') || 'test';
    
    const radioButton = document.querySelector(`input[name="envFilter"][value="${savedEnv}"]`);
    if (radioButton) {
        radioButton.checked = true;
    }
    
    // Add event listeners for environment filter changes
    const radioButtons = document.querySelectorAll('input[name="envFilter"]');
    
    radioButtons.forEach(radio => {
        radio.addEventListener('change', function() {
            localStorage.setItem('pacs-environment-filter', this.value);
            filterPacsByEnvironment();
        });
    });
}

async function loadPacsConfigs() {
    try {
        const response = await fetch('/api/pacs/configs');
        const data = await response.json();
        
        // Store all configs globally for filtering
        window.allPacsConfigs = data.configs || [];
        
        // Apply environment filtering
        filterPacsByEnvironment();
        
    } catch (error) {
        console.error('Error loading PACS configs:', error);
        console.error('Error details:', error.message, error.stack);
        document.getElementById('queryPacsSelect').innerHTML = '<option value="">Error loading PACS configs</option>';
    }
}

function filterPacsByEnvironment() {
    const select = document.getElementById('queryPacsSelect');
    
    const selectedRadio = document.querySelector('input[name="envFilter"]:checked');
    if (!selectedRadio) {
        return;
    }
    
    const selectedEnv = selectedRadio.value;
    
    // Clear current options
    select.innerHTML = '';
    
    if (!window.allPacsConfigs || window.allPacsConfigs.length === 0) {
        select.innerHTML = '<option value="">No PACS configurations available</option>';
        return;
    }
    
    // Filter configs by environment
    const filteredConfigs = window.allPacsConfigs.filter(config => {
        if (selectedEnv === 'both') return true;
        return config.environment === selectedEnv;
    });
    
    if (filteredConfigs.length === 0) {
        select.innerHTML = `<option value="">No ${selectedEnv} PACS configurations available</option>`;
        return;
    }
    
    let hasRememberedSelection = false;
    const rememberedPacs = window.PacsMemory ? window.PacsMemory.getRememberedPacs() : null;
    
    filteredConfigs.forEach(config => {
        const option = document.createElement('option');
        option.value = config.id;
        
        // Check if PACS is down
        const isDown = config.test_status === 'failed';
        
        if (isDown) {
            // Show down PACS in red and disable selection
            option.textContent = `${config.name} (${config.host}:${config.port}) - DOWN`;
            option.style.color = '#dc3545'; // Red
            option.style.fontWeight = 'bold';
            option.disabled = true;
            option.dataset.status = 'down';
        } else {
            // Normal PACS with environment color coding
            option.textContent = `${config.name} (${config.host}:${config.port})`;
            option.dataset.status = 'up';
            
            // Apply color coding based on environment
            if (config.environment === 'prod') {
                option.style.color = '#6f42c1'; // Dark purple
                option.style.fontWeight = 'bold';
            } else if (config.environment === 'test') {
                option.style.color = '#198754'; // Dark green
                option.style.fontWeight = 'bold';
            }
        }
        
        option.dataset.pacsName = config.name;
        option.dataset.pacsHost = config.host;
        option.dataset.pacsPort = config.port;
        option.dataset.environment = config.environment;
        
        // Prefer remembered selection over default
        if (rememberedPacs && config.id === rememberedPacs) {
            option.selected = true;
            hasRememberedSelection = true;
        } else if (!hasRememberedSelection && config.is_default) {
            option.selected = true;
        }
        
        select.appendChild(option);
    });
    
    // Setup event listeners for the select
    setupPacsSelectEventListeners(select);
    
    // Update hint for initial selection
    updateSelectedPacsHint();
}

function setupPacsSelectEventListeners(select) {
    // Remove existing listeners to avoid duplicates
    select.removeEventListener('change', handlePacsSelectChange);
    select.removeEventListener('click', handlePacsSelectClick);
    
    // Add new listeners
    select.addEventListener('change', handlePacsSelectChange);
    select.addEventListener('click', handlePacsSelectClick);
}

function handlePacsSelectChange() {
    updateSelectedPacsHint();
}

function handlePacsSelectClick() {
    setTimeout(() => updateSelectedPacsHint(), 100);
}

function updateSelectedPacsHint(selectedValues = null) {
    const hint = document.getElementById('selectedPacsHint');
    const hintText = document.getElementById('selectedPacsText');
    const select = document.getElementById('queryPacsSelect');
    
    if (!selectedValues) {
        // Get selected values from standard selectedOptions
        selectedValues = Array.from(select.selectedOptions).map(option => option.value);
    }
    
    // Filter out empty values
    selectedValues = selectedValues.filter(value => value && value !== '');
    
    if (selectedValues.length === 0) {
        hint.style.display = 'none';
    } else if (selectedValues.length === 1) {
        const option = document.querySelector(`#queryPacsSelect option[value="${selectedValues[0]}"]`);
        hint.style.display = 'block';
        hintText.textContent = `Selected: ${option ? option.textContent : 'Unknown PACS'}`;
    } else {
        // Get the names of selected PACS servers
        const selectedPacsNames = selectedValues.map(value => {
            const option = document.querySelector(`#queryPacsSelect option[value="${value}"]`);
            return option ? option.textContent : 'Unknown PACS';
        });
        
        hint.style.display = 'block';
        hintText.textContent = `Selected ${selectedValues.length} PACS servers: ${selectedPacsNames.join(', ')}`;
    }
    
    // Debug logging
    console.log('PACS selection updated:', selectedValues);
}

function clearCommandLog() {
    const log = document.getElementById('commandLog');
    log.innerHTML = `
        <div class="text-center py-4">
            <i class="fas fa-terminal fa-2x mb-2 opacity-50"></i>
            <div>DICOM command output will appear here</div>
            <small class="text-muted">Run a query to see command logs</small>
        </div>
    `;
}

function addLogEntry(type, message, timestamp = null) {
    const log = document.getElementById('commandLog');
    const time = timestamp || new Date().toLocaleTimeString();
    
    // Clear placeholder if it exists
    if (log.querySelector('.text-center')) {
        log.innerHTML = '';
    }
    
    const logEntry = document.createElement('div');
    logEntry.className = `mb-1 ${type === 'error' ? 'text-danger' : type === 'success' ? 'text-success' : type === 'warning' ? 'text-warning' : 'text-info'}`;
    
    const icon = type === 'error' ? 'fa-exclamation-circle' : 
                type === 'success' ? 'fa-check-circle' : 
                type === 'warning' ? 'fa-exclamation-triangle' : 
                'fa-info-circle';
    
    logEntry.innerHTML = `
        <span class="text-muted">[${time}]</span> 
        <i class="fas ${icon}"></i> 
        ${message}
    `;
    
    log.appendChild(logEntry);
    
    // Auto-scroll to bottom
    const container = document.getElementById('commandLogContainer');
    container.scrollTop = container.scrollHeight;
}

function addCommandOutput(command, output, exitCode = 0) {
    const log = document.getElementById('commandLog');
    const time = new Date().toLocaleTimeString();
    
    // Clear placeholder if it exists
    if (log.querySelector('.text-center')) {
        log.innerHTML = '';
    }
    
    // Add command entry
    const commandEntry = document.createElement('div');
    commandEntry.className = 'mb-2';
    commandEntry.innerHTML = `
        <div class="text-muted">[${time}] <i class="fas fa-terminal"></i> <strong>Command:</strong></div>
        <div class="text-info ps-3 font-monospace" style="font-size: 0.65rem; line-height: 1.1;">${command}</div>
    `;
    log.appendChild(commandEntry);
    
    // Add output entry
    if (output) {
        const outputEntry = document.createElement('div');
        outputEntry.className = `mb-2 ${exitCode === 0 ? 'text-success' : 'text-danger'}`;
        outputEntry.innerHTML = `
            <div class="text-muted ps-3"><i class="fas fa-arrow-right"></i> <strong>Output:</strong></div>
            <pre class="ps-4 mb-0" style="font-size: 0.65rem; line-height: 1.1;">${output}</pre>
        `;
        log.appendChild(outputEntry);
    }
    
    // Add separator
    const separator = document.createElement('hr');
    separator.className = 'my-2 opacity-25';
    log.appendChild(separator);
    
    // Auto-scroll to bottom
    const container = document.getElementById('commandLogContainer');
    container.scrollTop = container.scrollHeight;
}

let queryCancelled = false;
let currentQueryController = null;

async function queryPacs() {
    const select = document.getElementById('queryPacsSelect');
    let selectedOptions;
    
    // Get selected options from standard selectedOptions
    selectedOptions = select.selectedOptions;
    const patientName = document.getElementById('patientNameQuery').value.trim();
    const patientId = document.getElementById('patientIdQuery').value.trim();
    const accession = document.getElementById('accessionQuery').value.trim();
    const studyUid = document.getElementById('studyUidQuery').value.trim();
    const seriesUid = document.getElementById('seriesUidQuery').value.trim();
    const daysAgo = parseInt(document.getElementById('daysAgo').value) || 0;
    const maxResults = parseInt(document.getElementById('maxResults').value) || 100;
    
    if (selectedOptions.length === 0) {
        alert('Please select at least one PACS server');
        return;
    }
    
    // Reset cancellation flag
    queryCancelled = false;
    
    // Show loading with cancel button
    const submitBtn = document.querySelector('#pacsQueryForm button[type="submit"]');
    const originalContent = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Querying... <button type="button" class="btn btn-sm btn-outline-light ms-2" onclick="cancelQuery()">Cancel</button>';
    submitBtn.disabled = true;
    
    // Clear previous results
    currentResults = [];
    document.getElementById('queryResults').innerHTML = `
        <div class="text-center py-3">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Searching...</span>
            </div>
            <div class="mt-2">Querying ${selectedOptions.length} PACS server(s)...</div>
        </div>
    `;
    
    // Build search criteria log
    const criteria = [];
    if (patientName) criteria.push(`Patient Name: ${patientName}`);
    if (patientId) criteria.push(`Patient ID: ${patientId}`);
    if (accession) criteria.push(`Accession: ${accession}`);
    if (studyUid) criteria.push(`Study UID: ${studyUid.substring(0, 40)}...`);
    if (seriesUid) criteria.push(`Series UID: ${seriesUid.substring(0, 40)}...`);
    if (daysAgo > 0) criteria.push(`Date range: Last ${daysAgo} days`);
    criteria.push(`Max results: ${maxResults}`);
    
    if (criteria.length > 0) {
        addLogEntry('info', `Search criteria: ${criteria.join(', ')}`);
    }
    
    const allResults = [];
    const pacsResults = [];
    
    try {
        // Query each PACS sequentially
        for (let i = 0; i < selectedOptions.length; i++) {
            if (queryCancelled) {
                addLogEntry('warning', 'Query cancelled by user');
                break;
            }
            
            const pacsOption = selectedOptions[i];
            const pacsId = pacsOption.value;
            const pacsName = pacsOption.textContent;
            const pacsShortName = pacsOption.dataset.pacsName || pacsName.split(' (')[0];
            
            addLogEntry('info', `Querying PACS ${i + 1}/${selectedOptions.length}: ${pacsName}`);
            
            // Create abort controller for this query
            currentQueryController = new AbortController();
            
            try {
                const response = await fetch('/api/pacs/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        pacs_config_id: pacsId,
                        patient_name: patientName,
                        patient_id: patientId,
                        accession_number: accession,
                        study_uid: studyUid,
                        series_uid: seriesUid,
                        days_ago: daysAgo,
                        max_results: maxResults
                    }),
                    signal: currentQueryController.signal
                });
                
                if (queryCancelled) break;
                
                const data = await response.json();
                
                if (data.success) {
                    // Add PACS information to each result
                    const pacsResults = data.results.map(result => ({
                        ...result,
                        pacs_name: pacsName,
                        pacs_short_name: pacsShortName,
                        pacs_id: pacsId
                    }));
                    
                    allResults.push(...pacsResults);
                    
                    addLogEntry('success', `PACS ${pacsName}: Found ${data.results.length} result(s)`);
                    
                    // Add command output if available
                    if (data.command_output) {
                        addCommandOutput(data.command_output.command, data.command_output.output, data.command_output.exit_code);
                    }
                } else {
                    addLogEntry('error', `PACS ${pacsName}: Query failed - ${data.error}`);
                    if (data.command_output) {
                        addCommandOutput(data.command_output.command, data.command_output.output, data.command_output.exit_code);
                    }
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    addLogEntry('warning', `PACS ${pacsName}: Query cancelled`);
                } else {
                    addLogEntry('error', `PACS ${pacsName}: Network error - ${error.message}`);
                }
            }
        }
        
        if (!queryCancelled) {
            // Sort all results by study date (newest first)
            allResults.sort((a, b) => {
                const dateA = a.study_date || '19000101';
                const dateB = b.study_date || '19000101';
                return dateB.localeCompare(dateA);
            });
            
            currentResults = allResults;
            currentQueryInfo = {
                pacs_count: selectedOptions.length,
                total_results: allResults.length,
                max_results_requested: maxResults,
                search_criteria: {
                    patient_name: patientName,
                    patient_id: patientId,
                    accession_number: accession,
                    study_uid: studyUid,
                    series_uid: seriesUid,
                    days_ago: daysAgo
                }
            };
            
            addLogEntry('success', `All queries completed - Total: ${allResults.length} result(s) from ${selectedOptions.length} PACS server(s)`);
            
            displayResults(allResults, currentQueryInfo);
        }
    } catch (error) {
        addLogEntry('error', `Query error: ${error.message}`);
        displayError(`Query error: ${error.message}`);
    } finally {
        currentQueryController = null;
        submitBtn.innerHTML = originalContent;
        submitBtn.disabled = false;
    }
}

function cancelQuery() {
    queryCancelled = true;
    if (currentQueryController) {
        currentQueryController.abort();
    }
    addLogEntry('warning', 'Cancelling queries...');
}

function displayResults(results, queryInfo) {
    const container = document.getElementById('queryResults');
    const exportBtn = document.getElementById('exportBtn');
    
    if (results.length === 0) {
        const maxResultsInfo = queryInfo.max_results_requested ? 
            `<br><strong>Max Results per PACS:</strong> ${queryInfo.max_results_requested} (0 total returned)` : '';
        
        const pacsInfo = queryInfo.pacs_count > 1 ? 
            `<br><strong>PACS Servers:</strong> ${queryInfo.pacs_count} servers queried` : '';
        
        container.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <strong>Query Results</strong><br>
                Found 0 result(s)${maxResultsInfo}${pacsInfo}<br>
                <strong>Search Criteria:</strong> ${formatSearchCriteria(queryInfo.search_criteria)}
            </div>
            <div class="text-center py-4">
                <i class="fas fa-search fa-3x mb-3 opacity-25"></i>
                <h5>No Results Found</h5>
                <p class="text-muted">Try adjusting your search criteria or date range</p>
            </div>
        `;
        exportBtn.style.display = 'none';
        return;
    }
    
    // Show export button
    exportBtn.style.display = 'inline-block';
    
    // Create results summary
    const maxResultsInfo = queryInfo.max_results_requested ? 
        `<br><strong>Max Results per PACS:</strong> ${queryInfo.max_results_requested} (${results.length} total returned)` : '';
    
    const pacsInfo = queryInfo.pacs_count > 1 ? 
        `<br><strong>PACS Servers:</strong> ${queryInfo.pacs_count} servers queried` : '';
    
    const summaryHtml = `
        <div class="alert alert-info mb-3">
            <i class="fas fa-info-circle"></i>
            <strong>Query Results</strong><br>
            Found ${results.length} result(s)${maxResultsInfo}${pacsInfo}<br>
            <strong>Search Criteria:</strong> ${formatSearchCriteria(queryInfo.search_criteria)}
        </div>
    `;
    
    // Determine if we need PACS column (multiple PACS selected)
    const hasMultiplePacs = results.some(result => result.pacs_name);
    const pacsColumn = hasMultiplePacs ? '<th>PACS</th>' : '';
    
    // Create table with optimized column widths based on priority
    const tableHtml = `
        <div class="table-responsive">
            <table class="table table-striped table-hover table-sm" id="resultsTable" style="table-layout: fixed; font-size: 0.8rem;">
                <thead class="table-dark">
                    <tr>
                        ${hasMultiplePacs ? '<th style="max-width: 80px; width: 80px; min-width: 60px;">PACS</th>' : ''}
                        <th style="width: 140px; min-width: 120px;">PATIENT NAME</th>
                        <th style="width: 100px; min-width: 90px;">PATIENT ID</th>
                        <th style="width: 90px; min-width: 80px;">DATE</th>
                        <th style="width: 70px; min-width: 60px;">TIME</th>
                        <th style="width: 120px; min-width: 100px;">STUDY DESCRIPTION</th>
                        <th style="width: 160px; min-width: 140px;">ACCESSION</th>
                        <th style="width: 70px; min-width: 60px;">MODALITY</th>
                        <th style="width: 50px; min-width: 40px;">SERIES</th>
                        <th style="width: 50px; min-width: 40px;">IMAGES</th>
                        <th style="width: 140px; min-width: 120px;">STUDY UID</th>
                    </tr>
                </thead>
                <tbody>
                    ${results.map((result, index) => `
                        <tr onclick="showStudyDetails(${index})" style="cursor: pointer;" 
                            title="Click to view detailed study information" data-bs-toggle="tooltip">
                                                    ${hasMultiplePacs ? `
                            <td style="max-width: 80px; width: 80px; min-width: 60px;">
                                <span class="text-muted" title="${result.pacs_name || 'Unknown PACS'}" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: block; max-width: 100%;">
                                    ${result.pacs_short_name || result.pacs_name || '-'}
                                </span>
                            </td>
                        ` : ''}
                            <td style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${result.patient_name || '-'}">${result.patient_name || '-'}</td>
                            <td style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${result.patient_id || '-'}">${result.patient_id || '-'}</td>
                            <td style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${result.study_date_formatted || result.study_date || '-'}">${result.study_date_formatted || result.study_date || '-'}</td>
                            <td style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${result.study_time || '-'}">${result.study_time || '-'}</td>
                            <td style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${result.study_description || '-'}">${result.study_description || '-'}</td>
                            <td style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${result.accession_number || '-'}">${result.accession_number || '-'}</td>
                            <td>
                                ${result.modality ? `<span class="badge bg-info badge-sm">${result.modality}</span>` : '-'}
                            </td>
                            <td>
                                ${result.series_count ? `<span class="badge bg-primary badge-sm">${result.series_count}</span>` : '-'}
                            </td>
                            <td>
                                ${result.instance_count ? `<span class="badge bg-secondary badge-sm">${result.instance_count}</span>` : '-'}
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <small class="text-muted font-monospace me-1" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                        ${result.study_uid ? result.study_uid.substring(0, 18) + '...' : '-'}
                                    </small>
                                    ${result.study_uid ? `
                                        <button class="btn btn-sm btn-outline-secondary btn-sm" 
                                                onclick="copyToClipboard('${result.study_uid}', 'Study UID', event)"
                                                title="Copy full Study UID to clipboard">
                                            <i class="fas fa-copy fa-xs"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
    
    container.innerHTML = summaryHtml + tableHtml;
    
    // Add compact CSS styles
    addCompactStyles();
    
    // Add sort indicator styles
    addSortStyles();
    
    // Initialize the custom table after the HTML is rendered
    const tableElement = document.querySelector('#resultsTable');
    if (tableElement) {
        if (window.queryResultsTable) {
            window.queryResultsTable.destroy(); // Clean up previous instance
        }
        window.queryResultsTable = new CustomTable('#resultsTable');
        window.queryResultsTable.setData(results);
        console.log('Query results table initialized and data set successfully');
    } else {
        console.warn('Results table element not found, cannot initialize custom table.');
    }
}

function displayError(error) {
    const container = document.getElementById('queryResults');
    const exportBtn = document.getElementById('exportBtn');
    
    container.innerHTML = `
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Query Error</strong><br>
            ${error}
        </div>
        <div class="text-center py-4">
            <i class="fas fa-exclamation-triangle fa-3x mb-3 text-warning"></i>
            <h5>Query Failed</h5>
            <p class="text-muted">Please check the DICOM Command Log for details</p>
        </div>
    `;
    
    exportBtn.style.display = 'none';
}

function formatSearchCriteria(criteria) {
    const parts = [];
    if (criteria.patient_name) parts.push(`Patient Name: ${criteria.patient_name}`);
    if (criteria.patient_id) parts.push(`Patient ID: ${criteria.patient_id}`);
    if (criteria.accession_number) parts.push(`Accession: ${criteria.accession_number}`);
    if (criteria.study_uid) parts.push(`Study UID: ${criteria.study_uid.substring(0, 30)}... <button class="btn btn-sm btn-outline-secondary ms-1" onclick="copyToClipboard('${criteria.study_uid}', 'Study UID', event)" title="Copy full Study UID"><i class="fas fa-copy"></i></button>`);
    if (criteria.series_uid) parts.push(`Series UID: ${criteria.series_uid.substring(0, 30)}... <button class="btn btn-sm btn-outline-secondary ms-1" onclick="copyToClipboard('${criteria.series_uid}', 'Series UID', event)" title="Copy full Series UID"><i class="fas fa-copy"></i></button>`);
    if (criteria.days_ago > 0) parts.push(`Date range: Last ${criteria.days_ago} days`);
    
    return parts.length > 0 ? parts.join(', ') : 'All studies';
}

async function showStudyDetails(index) {
    let study = currentResults[index];
    if (!study) return;
    
    // Store the current study for C-MOVE operations
    currentStudyForCMove = study;
    
    // Add log entry for opening study details
    addLogEntry('info', `Opening study details for Study UID: ${study.study_uid.substring(0, 40)}...`);
    
    // Automatically query for series details if not already available
    if (!study.series_details || study.series_details.length === 0) {
        addLogEntry('info', 'Querying for series-level details...');
        await querySeriesDetailsForStudy(study.study_uid, index);
        // Re-fetch the updated study data after querying
        study = currentResults[index];
    }
    
    // Format dates
    const studyDate = study.study_date_formatted || study.study_date || 'Unknown';
    const studyTime = study.study_time || 'Unknown';
    
    // Build the detailed view HTML
    let detailsHtml = `
        <div class="row">
            <div class="col-md-6">
                <h6 class="border-bottom pb-2"><i class="fas fa-user"></i> Patient Information</h6>
                <dl class="row" style="font-size: 0.85rem;">
                    <dt class="col-sm-5">Patient Name:</dt>
                    <dd class="col-sm-7">${study.patient_name || 'Unknown'}</dd>
                    
                    <dt class="col-sm-5">Patient ID:</dt>
                    <dd class="col-sm-7">${study.patient_id || 'Unknown'}</dd>
                    
                    <dt class="col-sm-5">Birth Date:</dt>
                    <dd class="col-sm-7">${study.patient_birth_date || 'Not Available'}</dd>
                    
                    <dt class="col-sm-5">Sex:</dt>
                    <dd class="col-sm-7">${study.patient_sex || 'Not Available'}</dd>
                </dl>
            </div>
            
            <div class="col-md-6">
                <h6 class="border-bottom pb-2"><i class="fas fa-file-medical"></i> Study Information</h6>
                <dl class="row" style="font-size: 0.85rem;">
                    <dt class="col-sm-5">Study Date:</dt>
                    <dd class="col-sm-7">${studyDate}</dd>
                    
                    <dt class="col-sm-5">Study Time:</dt>
                    <dd class="col-sm-7">${studyTime}</dd>
                    
                    <dt class="col-sm-5">Accession:</dt>
                    <dd class="col-sm-7">${study.accession_number || 'Unknown'}</dd>
                    
                    <dt class="col-sm-5">Modality:</dt>
                    <dd class="col-sm-7">${study.modality ? `<span class="badge bg-info">${study.modality}</span>` : 'Unknown'}</dd>
                </dl>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-12">
                <h6 class="border-bottom pb-2"><i class="fas fa-info-circle"></i> Study Details</h6>
                <dl class="row">
                    <dt class="col-sm-3">Study Description:</dt>
                    <dd class="col-sm-9">${study.study_description || 'No description available'}</dd>
                    
                    <dt class="col-sm-3">Study Instance UID:</dt>
                    <dd class="col-sm-9">
                        <div class="d-flex align-items-start">
                            <small class="font-monospace text-break me-2" style="word-break: break-all;">
                                ${study.study_uid || 'Unknown'}
                            </small>
                            ${study.study_uid ? `
                                <button class="btn btn-sm btn-outline-secondary" 
                                        onclick="copyToClipboard('${study.study_uid}', 'Study UID', event)"
                                        title="Copy full Study UID to clipboard">
                                    <i class="fas fa-copy"></i>
                                </button>
                            ` : ''}
                        </div>
                    </dd>
                    
                    <dt class="col-sm-3">Referring Physician:</dt>
                    <dd class="col-sm-9">${study.referring_physician || 'Not Available'}</dd>
                    
                    <dt class="col-sm-3">Institution:</dt>
                    <dd class="col-sm-9">${study.institution_name || 'Not Available'}</dd>
                </dl>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-12">
                <h6 class="border-bottom pb-2"><i class="fas fa-layer-group"></i> Series</h6>
                <div class="table-responsive">
                    <table class="table table-sm" style="font-size: 0.8rem;">
                        <thead>
                            <tr>
                                <th style="width: 8%;">Series #</th>
                                <th style="width: 22%;">Description</th>
                                <th style="width: 35%;">Series UID</th>
                                <th style="width: 10%;">Modality</th>
                                <th style="width: 10%;">Images</th>
                                <th style="width: 15%;">Procedure Code</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${study.series_details && study.series_details.length > 0 ? 
                                study.series_details.map(series => `
                                    <tr>
                                        <td>${series.series_number || '-'}</td>
                                        <td>${series.series_description || '-'}</td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <small class="font-monospace text-truncate d-inline-block me-2" style="max-width: 250px;" 
                                                       title="${series.series_uid || '-'}">
                                                    ${series.series_uid ? series.series_uid.substring(0, 25) + '...' : '-'}
                                                </small>
                                                ${series.series_uid ? `
                                                                                                    <button class="btn btn-sm btn-outline-secondary" 
                                                        onclick="copyToClipboard('${series.series_uid}', 'Series UID', event)"
                                                        title="Copy full Series UID to clipboard">
                                                        <i class="fas fa-copy"></i>
                                                    </button>
                                                ` : ''}
                                            </div>
                                        </td>
                                        <td><span class="badge bg-info">${series.modality || study.modality || '-'}</span></td>
                                        <td><span class="badge bg-secondary">${series.instance_count || '-'}</span></td>
                                        <td>${series.procedure_code || series.series_description || '-'}</td>
                                    </tr>
                                `).join('') : 
                                `<tr>
                                    <td colspan="6" class="text-center">
                                        <small class="text-muted">
                                            Total Series: ${study.series_count || '0'} | 
                                            Total Images: ${study.instance_count || '0'}
                                        </small>
                                    </td>
                                </tr>`
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    
    // Update modal content
    document.getElementById('studyDetailsContent').innerHTML = detailsHtml;
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('studyDetailsModal'));
    modal.show();
}

async function querySeriesDetailsForStudy(studyUid, studyIndex) {
    try {
        // Query for series-level details
        const pacsId = document.getElementById('queryPacsSelect').value;
        const pacsName = document.getElementById('queryPacsSelect').selectedOptions[0].textContent;
        
        addLogEntry('info', `Performing series-level query on ${pacsName}`);
        
        const response = await fetch('/api/pacs/query-series', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                pacs_config_id: pacsId,
                study_uid: studyUid
            })
        });
        
        const data = await response.json();
        
        // Add command output to log if available
        if (data.command_output) {
            addCommandOutput(data.command_output.command, data.command_output.output, data.command_output.exit_code);
        }
        
        if (data.success && data.series_details) {
            addLogEntry('success', `Found ${data.series_details.length} series for study`);
            
            // Log each series found
            data.series_details.forEach(series => {
                addLogEntry('info', `Series ${series.series_number}: ${series.series_description || 'No description'} (${series.instance_count} images)`);
            });
            
            // Update the current result with series details
            if (studyIndex >= 0) {
                currentResults[studyIndex].series_details = data.series_details;
            }
        } else {
            addLogEntry('warning', 'No series details found or query failed');
        }
    } catch (error) {
        console.error('Error querying series details:', error);
        addLogEntry('error', `Failed to query series details: ${error.message}`);
    }
}

async function exportResults() {
    if (currentResults.length === 0) {
        alert('No results to export');
        return;
    }
    
    try {
        // Prepare results for export with full PACS names
        const exportResults = currentResults.map(result => {
            const exportResult = { ...result };
            
            // If we have PACS information, use full PACS name for export
            if (result.pacs_name) {
                exportResult.pacs_name = result.pacs_name;
            }
            
            return exportResult;
        });
        
        const response = await fetch('/api/dicom/export/csv', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                results: exportResults,
                query_info: currentQueryInfo
            })
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pacs_query_results_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.csv`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        } else {
            alert('Failed to export results');
        }
    } catch (error) {
        console.error('Export error:', error);
        alert('Error exporting results');
    }
}

function showCMoveDialog() {
    // Store the current study for C-MOVE
    if (!currentStudyForCMove) {
        alert('No study selected for C-MOVE');
        return;
    }
    
    // Get source PACS name for the title
    const sourcePacsName = document.getElementById('queryPacsSelect').selectedOptions[0]?.textContent || 'Unknown PACS';
    document.getElementById('cMoveModalLabel').innerHTML = `<i class="fas fa-exchange-alt"></i> C-MOVE Study from ${sourcePacsName}`;
    
    // Initialize C-MOVE environment filter
    initializeCMoveEnvironmentFilter();
    
    // Load available PACS configs (excluding the source PACS)
    loadDestinationPacsConfigs();
    
    // Update study info display with abbreviated UID
    const abbreviatedUid = currentStudyForCMove.study_uid ? 
        currentStudyForCMove.study_uid.substring(0, 30) + '...' : 'Unknown';
    
    const studyInfo = `${currentStudyForCMove.patient_name} - ${currentStudyForCMove.study_description || 'No description'}<br>
                      Study UID: ${abbreviatedUid} 
                      ${currentStudyForCMove.study_uid ? `<button class="btn btn-sm btn-outline-secondary ms-1" onclick="copyToClipboard('${currentStudyForCMove.study_uid}', 'Study UID', event)" title="Copy full Study UID"><i class="fas fa-copy"></i></button>` : ''}<br>
                      Date: ${currentStudyForCMove.study_date_formatted || currentStudyForCMove.study_date}`;
    document.getElementById('cMoveStudyInfo').innerHTML = studyInfo;
    
    // Show the C-MOVE modal with proper z-index handling
    const modal = new bootstrap.Modal(document.getElementById('cMoveModal'));
    modal.show();
    
    // Ensure the C-MOVE modal and its backdrop appear above the study details modal
    document.getElementById('cMoveModal').addEventListener('shown.bs.modal', function() {
        // Set higher z-index for the modal and backdrop
        this.style.zIndex = 1070;
        const backdrop = document.querySelector('.modal-backdrop:last-child');
        if (backdrop) {
            backdrop.style.zIndex = 1065;
        }
    });
}

async function loadDestinationPacsConfigs() {
    try {
        const response = await fetch('/api/pacs/configs');
        const data = await response.json();
        
        // Store all configs globally for C-MOVE filtering
        window.cMovePacsConfigs = data.configs || [];
        
        // Apply environment filtering for C-MOVE
        filterCMovePacsByEnvironment();
        
    } catch (error) {
        console.error('Error loading destination PACS configs:', error);
        document.getElementById('cMovePacsSelect').innerHTML = '<option value="">Error loading PACS configs</option>';
    }
}

function initializeCMoveEnvironmentFilter() {
    // Load saved environment preference for C-MOVE
    const savedEnv = localStorage.getItem('cMove-pacs-environment-filter') || 'test';
    
    const radioButton = document.querySelector(`input[name="cMoveEnvFilter"][value="${savedEnv}"]`);
    if (radioButton) {
        radioButton.checked = true;
    }
    
    // Add event listeners for environment filter changes
    const radioButtons = document.querySelectorAll('input[name="cMoveEnvFilter"]');
    
    radioButtons.forEach(radio => {
        radio.addEventListener('change', function() {
            localStorage.setItem('cMove-pacs-environment-filter', this.value);
            filterCMovePacsByEnvironment();
        });
    });
}

function filterCMovePacsByEnvironment() {
    const select = document.getElementById('cMovePacsSelect');
    
    const selectedRadio = document.querySelector('input[name="cMoveEnvFilter"]:checked');
    if (!selectedRadio) {
        return;
    }
    
    const selectedEnv = selectedRadio.value;
    
    // Clear current options
    select.innerHTML = '';
    
    if (!window.cMovePacsConfigs || window.cMovePacsConfigs.length === 0) {
        select.innerHTML = '<option value="">No PACS configurations available</option>';
        return;
    }
    
    // Get current source PACS ID to exclude it and get its routing config
    const sourcePacsId = document.getElementById('queryPacsSelect').value;
    const sourcePacsConfig = window.cMovePacsConfigs.find(c => c.id === sourcePacsId);
    
    // Filter configs by environment, exclude source PACS, and only include those with routing configured
    const filteredConfigs = window.cMovePacsConfigs.filter(config => {
        if (config.id === sourcePacsId) return false; // Exclude source PACS
        
        // Only include PACS that have C-MOVE routing configured from the source PACS
        if (!sourcePacsConfig || !sourcePacsConfig.move_routing || !sourcePacsConfig.move_routing[config.id]) {
            return false;
        }
        
        // Check environment filter
        if (selectedEnv === 'both') return true;
        return config.environment === selectedEnv;
    });
    
    if (filteredConfigs.length === 0) {
        select.innerHTML = `<option value="">No ${selectedEnv} PACS configurations available with C-MOVE routing configured</option>`;
        return;
    }
    
    filteredConfigs.forEach(config => {
        const option = document.createElement('option');
        option.value = config.id;
        
        // Get the configured AE for routing to this destination
        const configuredAE = sourcePacsConfig.move_routing[config.id];
        
        // Check if PACS is down
        const isDown = config.test_status === 'failed';
        
        if (isDown) {
            // Show down PACS in red and disable selection
            option.textContent = `${config.name} (${config.host}:${config.port}) [${configuredAE}] - DOWN`;
            option.style.color = '#dc3545'; // Red
            option.style.fontWeight = 'bold';
            option.disabled = true;
            option.dataset.status = 'down';
        } else {
            // Normal PACS with environment color coding and configured AE
            option.textContent = `${config.name} (${config.host}:${config.port}) [${configuredAE}]`;
            option.dataset.status = 'up';
            
            // Apply color coding based on environment
            if (config.environment === 'prod') {
                option.style.color = '#6f42c1'; // Dark purple
                option.style.fontWeight = 'bold';
            } else if (config.environment === 'test') {
                option.style.color = '#198754'; // Dark green
                option.style.fontWeight = 'bold';
            }
        }
        
        option.dataset.pacsName = config.name;
        option.dataset.pacsHost = config.host;
        option.dataset.pacsPort = config.port;
        option.dataset.environment = config.environment;
        
        select.appendChild(option);
    });
    
    // Setup event listeners for the C-MOVE select
    setupCMovePacsSelectEventListeners(select);
    
    // Update hint for initial selection
    updateCMoveSelectedPacsHint();
}

function setupCMovePacsSelectEventListeners(select) {
    // Remove existing listeners to avoid duplicates
    select.removeEventListener('change', handleCMovePacsSelectChange);
    select.removeEventListener('click', handleCMovePacsSelectClick);
    
    // Add new listeners
    select.addEventListener('change', handleCMovePacsSelectChange);
    select.addEventListener('click', handleCMovePacsSelectClick);
}

function handleCMovePacsSelectChange() {
    updateCMoveSelectedPacsHint();
    updateCMoveButtonState();
}

function handleCMovePacsSelectClick() {
    setTimeout(() => {
        updateCMoveSelectedPacsHint();
        updateCMoveButtonState();
    }, 100);
}

function updateCMoveSelectedPacsHint() {
    const hint = document.getElementById('cMoveSelectedPacsHint');
    const hintText = document.getElementById('cMoveSelectedPacsText');
    const select = document.getElementById('cMovePacsSelect');
    
    const selectedValues = Array.from(select.selectedOptions).map(option => option.value);
    
    // Filter out empty values
    const validSelectedValues = selectedValues.filter(value => value && value !== '');
    
    if (validSelectedValues.length === 0) {
        hint.style.display = 'none';
    } else if (validSelectedValues.length === 1) {
        const option = document.querySelector(`#cMovePacsSelect option[value="${validSelectedValues[0]}"]`);
        hint.style.display = 'block';
        hintText.textContent = `Selected: ${option ? option.textContent : 'Unknown PACS'}`;
    } else {
        // Get the names of selected PACS servers
        const selectedPacsNames = validSelectedValues.map(value => {
            const option = document.querySelector(`#cMovePacsSelect option[value="${value}"]`);
            return option ? option.textContent : 'Unknown PACS';
        });
        
        hint.style.display = 'block';
        hintText.textContent = `Selected ${validSelectedValues.length} PACS servers: ${selectedPacsNames.join(', ')}`;
    }
}

function updateCMoveButtonState() {
    const select = document.getElementById('cMovePacsSelect');
    const button = document.getElementById('cMoveExecuteBtn');
    
    const selectedValues = Array.from(select.selectedOptions).map(option => option.value);
    const validSelectedValues = selectedValues.filter(value => value && value !== '');
    
    if (validSelectedValues.length > 0) {
        button.disabled = false;
        button.innerHTML = `<i class="fas fa-exchange-alt"></i> C-MOVE${validSelectedValues.length > 1 ? ` (${validSelectedValues.length} PACS)` : ''}`;
    } else {
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-exchange-alt"></i> C-MOVE';
    }
}

async function executeCMove() {
    const select = document.getElementById('cMovePacsSelect');
    const selectedOptions = Array.from(select.selectedOptions).map(option => option.value);
    const validSelectedPacsIds = selectedOptions.filter(value => value && value !== '');
    
    if (validSelectedPacsIds.length === 0) {
        alert('Please select at least one destination PACS server');
        return;
    }
    
    if (!currentStudyForCMove) {
        alert('No study selected for C-MOVE');
        return;
    }
    
    // Get source PACS info
    const sourcePacsId = document.getElementById('queryPacsSelect').value;
    const sourcePacsName = document.getElementById('queryPacsSelect').selectedOptions[0]?.textContent || 'Unknown PACS';
    
    // Show loading state
    const cMoveBtn = document.getElementById('cMoveExecuteBtn');
    const originalContent = cMoveBtn.innerHTML;
    cMoveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Moving...';
    cMoveBtn.disabled = true;
    
    // Add initial log entry
    addLogEntry('info', `Starting C-MOVE operation from ${sourcePacsName} to ${validSelectedPacsIds.length} destination PACS`);
    addLogEntry('info', `Moving study: ${currentStudyForCMove.study_uid.substring(0, 40)}...`);
    
    let successCount = 0;
    let failureCount = 0;
    
    try {
        // Execute C-MOVE operations sequentially
        for (let i = 0; i < validSelectedPacsIds.length; i++) {
            const destinationPacsId = validSelectedPacsIds[i];
            const destinationPacsName = document.querySelector(`#cMovePacsSelect option[value="${destinationPacsId}"]`)?.textContent || 'Unknown PACS';
            
            addLogEntry('info', `C-MOVE ${i + 1}/${validSelectedPacsIds.length}: ${sourcePacsName}  ${destinationPacsName}`);
            
            try {
                const response = await fetch('/api/pacs/c-move', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        source_pacs_id: sourcePacsId,
                        destination_pacs_id: destinationPacsId,
                        study_uid: currentStudyForCMove.study_uid,
                        patient_id: currentStudyForCMove.patient_id
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    successCount++;
                    addLogEntry('success', `C-MOVE ${i + 1}/${validSelectedPacsIds.length}: Successfully moved to ${destinationPacsName}`);
                    
                    // Add command output if available
                    if (data.command_output) {
                        addCommandOutput(data.command_output.command, data.command_output.output, data.command_output.exit_code);
                    }
                } else {
                    failureCount++;
                    addLogEntry('error', `C-MOVE ${i + 1}/${validSelectedPacsIds.length}: Failed to move to ${destinationPacsName} - ${data.error}`);
                    
                    if (data.command_output) {
                        addCommandOutput(data.command_output.command, data.command_output.output, data.command_output.exit_code);
                    }
                }
            } catch (error) {
                failureCount++;
                addLogEntry('error', `C-MOVE ${i + 1}/${validSelectedPacsIds.length}: Network error for ${destinationPacsName} - ${error.message}`);
            }
        }
        
        // Summary
        if (successCount > 0) {
            addLogEntry('success', `C-MOVE operations completed: ${successCount} successful, ${failureCount} failed`);
            
            // Close the C-MOVE modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('cMoveModal'));
            modal.hide();
            
            // Show success message
            if (failureCount === 0) {
                alert(`C-MOVE operations completed successfully! Moved study to ${successCount} PACS server(s).`);
            } else {
                alert(`C-MOVE operations completed with mixed results: ${successCount} successful, ${failureCount} failed. Check the DICOM Command Log for details.`);
            }
        } else {
            addLogEntry('error', `All C-MOVE operations failed (${failureCount} attempts)`);
            alert(`All C-MOVE operations failed. Check the DICOM Command Log for details.`);
        }
        
    } catch (error) {
        addLogEntry('error', `C-MOVE operation error: ${error.message}`);
        alert(`Error during C-MOVE operations: ${error.message}`);
    } finally {
        cMoveBtn.innerHTML = originalContent;
        cMoveBtn.disabled = false;
    }
}

// Utility function to copy text to clipboard
async function copyToClipboard(text, label, event) {
    // Prevent event from bubbling up to the row
    if (event) {
        event.stopPropagation();
        event.preventDefault();
    }
    
    try {
        await navigator.clipboard.writeText(text);
        
        // Show success feedback
        const button = event.target.closest('button');
        const originalContent = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i>';
        button.classList.remove('btn-outline-secondary');
        button.classList.add('btn-success');
        
        // Add log entry
        addLogEntry('success', `Copied ${label} to clipboard`);
        
        // Reset button after 2 seconds
        setTimeout(() => {
            button.innerHTML = originalContent;
            button.classList.remove('btn-success');
            button.classList.add('btn-outline-secondary');
        }, 2000);
        
    } catch (err) {
        console.error('Failed to copy to clipboard:', err);
        
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        
        // Show success feedback
        const button = event.target.closest('button');
        const originalContent = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i>';
        button.classList.remove('btn-success');
        button.classList.add('btn-outline-secondary');
        
        addLogEntry('success', `Copied ${label} to clipboard (fallback method)`);
        
        setTimeout(() => {
            button.innerHTML = originalContent;
            button.classList.remove('btn-success');
            button.classList.add('btn-outline-secondary');
        }, 2000);
    }
}

// Compact table styling function
function addCompactStyles() {
    if (!document.getElementById('compact-styles')) {
        const style = document.createElement('style');
        style.id = 'compact-styles';
        style.textContent = `
            /* Compact table styling */
            #queryResults .table {
                margin-bottom: 0.5rem;
                table-layout: fixed !important;
            }
            #queryResults .table td,
            #queryResults .table th {
                padding: 0.3rem 0.5rem;
                vertical-align: middle;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            #queryResults .badge {
                font-size: 0.65rem;
                padding: 0.2rem 0.4rem;
            }
            #queryResults .btn-sm {
                padding: 0.1rem 0.3rem;
                font-size: 0.65rem;
            }
            /* Force PACS column to be narrow */
            #queryResults .table th:first-child,
            #queryResults .table td:first-child {
                max-width: 80px !important;
                width: 80px !important;
                min-width: 60px !important;
            }
        `;
        document.head.appendChild(style);
    }
}

// Sort indicator styling function
function addSortStyles() {
    if (!document.getElementById('sort-styles')) {
        const style = document.createElement('style');
        style.id = 'sort-styles';
        style.textContent = `
            /* Sort indicator styles */
            #queryResults .table th.sortable {
                position: relative;
                cursor: pointer;
                user-select: none;
            }
            #queryResults .table th.sortable:hover {
                background-color: rgba(0, 123, 255, 0.1);
            }
            #queryResults .table th.sortable::after {
                content: '';
                position: absolute;
                right: 8px;
                color: #6c757d;
                font-size: 0.8rem;
            }
            #queryResults .table th.sortable.sort-asc::after {
                content: '';
                color: #007bff;
            }
            #queryResults .table th.sortable.sort-desc::after {
                content: '';
                color: #007bff;
            }
        `;
        document.head.appendChild(style);
    }
}
</script>
{% endblock %}