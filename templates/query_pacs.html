{% extends "base.html" %}

{% block title %}Query PACS - DICOM Fabricator{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-search"></i> Query PACS</h2>
        <p class="text-muted">Search and query DICOM studies on PACS servers</p>
    </div>
</div>

<!-- Query Form -->
<div class="row mb-4">
    <div class="col-xl-9">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-search"></i> Query PACS</h5>
            </div>
            <div class="card-body">
                <form id="pacsQueryForm">
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label for="queryPacsSelect" class="form-label">Select PACS</label>
                            <select id="queryPacsSelect" class="form-select">
                                <option value="">Loading...</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="daysAgo" class="form-label">Date Range</label>
                            <select id="daysAgo" class="form-select">
                                <option value="0">All dates</option>
                                <option value="1">Last 1 day</option>
                                <option value="7">Last 7 days</option>
                                <option value="30">Last 30 days</option>
                                <option value="90">Last 90 days</option>
                                <option value="365">Last year</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="maxResults" class="form-label">
                                Maximum Results 
                                <i class="fas fa-info-circle text-muted" data-bs-toggle="tooltip" 
                                   data-bs-placement="top" 
                                   title="Uses DICOM C-CANCEL to limit results, but some PACS servers may return more results than requested due to network buffering, query optimization, or incomplete C-CANCEL support."></i>
                            </label>
                            <input type="number" id="maxResults" class="form-control" value="100" min="1" max="1000" 
                                   title="Approximate maximum number of studies to return (1-1000)">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search"></i> Query PACS
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="patientNameQuery" class="form-label">Patient Name</label>
                                <input type="text" class="form-control" id="patientNameQuery" 
                                       placeholder="e.g., SMITH^JOHN or *SMITH*">
                                <div class="form-text">Supports wildcards: * and ?</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="patientIdQuery" class="form-label">Patient ID</label>
                                <input type="text" class="form-control" id="patientIdQuery" 
                                       placeholder="e.g., PID12345">
                            </div>
                            
                            <div class="mb-3">
                                <label for="accessionQuery" class="form-label">Accession Number</label>
                                <input type="text" class="form-control" id="accessionQuery" 
                                       placeholder="e.g., ACC001">
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="studyUidQuery" class="form-label">Study Instance UID</label>
                                <input type="text" class="form-control" id="studyUidQuery" 
                                       placeholder="e.g., 1.2.826.0.1.3680043.8.498.1...">
                            </div>
                            
                            <div class="mb-3">
                                <label for="seriesUidQuery" class="form-label">Series Instance UID</label>
                                <input type="text" class="form-control" id="seriesUidQuery" 
                                       placeholder="e.g., 1.2.826.0.1.3680043.8.498.2...">
                                <div class="form-text">Will switch to series-level query</div>
                            </div>
                            
                            <div class="alert alert-info mb-0">
                                <i class="fas fa-info-circle"></i>
                                <strong>Tips:</strong> Leave fields empty to search all values. 
                                Use wildcards (*) for partial matches. Combine criteria to narrow results.
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="fas fa-terminal"></i> DICOM Command Log</h6>
                <button class="btn btn-outline-secondary btn-sm" onclick="clearCommandLog()" 
                        title="Clear log" data-bs-toggle="tooltip">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            <div class="card-body p-2" style="height: 400px; overflow-y: auto;" id="commandLogContainer">
                <div id="commandLog" class="font-monospace text-muted" style="font-size: 0.65rem; line-height: 1.1;">
                    <div class="text-center py-4">
                        <i class="fas fa-terminal fa-2x mb-2 opacity-50"></i>
                        <div>DICOM command output will appear here</div>
                        <small class="text-muted">Run a query to see command logs</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Query Results Section -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-table"></i> Query Results</h5>
                <button class="btn btn-outline-primary btn-sm" onclick="exportResults()" 
                        id="exportBtn" style="display: none;">
                    <i class="fas fa-download"></i> Export CSV
                </button>
            </div>
            <div class="card-body">
                <div id="queryResults">
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-search fa-3x mb-3 opacity-25"></i>
                        <h5>No Query Results</h5>
                        <p>Use the query form above to search for DICOM studies</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- C-MOVE PACS Selection Modal -->
<div class="modal fade" id="cMoveModal" tabindex="-1" aria-labelledby="cMoveModalLabel" aria-hidden="true" 
     style="z-index: 1070;" data-bs-backdrop="true" data-bs-keyboard="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cMoveModalLabel">
                    <i class="fas fa-exchange-alt"></i> C-MOVE Study
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">Select the destination PACS server to move this study to:</p>
                
                <div class="mb-3">
                    <label for="destinationPacsSelect" class="form-label">Destination PACS Server</label>
                    <select id="destinationPacsSelect" class="form-select">
                        <option value="">Loading...</option>
                    </select>
                </div>
                
                <div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle"></i>
                    <strong>Study to Move:</strong>
                    <br>
                    <span id="cMoveStudyInfo">-</span>
                </div>
                
                <div class="alert alert-warning mb-0">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Note:</strong> C-MOVE will retrieve the study from the source PACS and store it on the destination PACS. 
                    This operation may take time depending on the study size and network conditions.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="executeCMove()">
                    <i class="fas fa-exchange-alt"></i> C-MOVE
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Study Details Modal -->
<div class="modal fade" id="studyDetailsModal" tabindex="-1" aria-labelledby="studyDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="studyDetailsModalLabel">
                    <i class="fas fa-info-circle"></i> Study Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="studyDetailsContent">
                <!-- Content will be dynamically populated -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-sm btn-primary" onclick="showCMoveDialog()">
                    <i class="fas fa-exchange-alt"></i> C-MOVE this study to...
                </button>
                <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentResults = [];
let currentQueryInfo = {};
let currentStudyForCMove = null;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadPacsConfigs();
    
    // Initialize form submission
    document.getElementById('pacsQueryForm').addEventListener('submit', function(e) {
        e.preventDefault();
        queryPacs();
    });
    
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

async function loadPacsConfigs() {
    try {
        const response = await fetch('/api/pacs/configs');
        const data = await response.json();
        
        const select = document.getElementById('queryPacsSelect');
        select.innerHTML = '';
        
        if (data.success && data.configs.length > 0) {
            // Add default option
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Select PACS server...';
            select.appendChild(defaultOption);
            
            let hasRememberedSelection = false;
            const rememberedPacs = window.PacsMemory ? window.PacsMemory.getRememberedPacs() : null;
            
            data.configs.forEach(config => {
                const option = document.createElement('option');
                option.value = config.id;
                option.textContent = `${config.name} (${config.host}:${config.port})`;
                
                // Prefer remembered selection over default
                if (rememberedPacs && config.id === rememberedPacs) {
                    option.selected = true;
                    hasRememberedSelection = true;
                } else if (!hasRememberedSelection && config.is_default) {
                    option.selected = true;
                }
                
                select.appendChild(option);
            });
        } else {
            select.innerHTML = '<option value="">No PACS configurations available</option>';
        }
    } catch (error) {
        console.error('Error loading PACS configs:', error);
        document.getElementById('queryPacsSelect').innerHTML = '<option value="">Error loading PACS configs</option>';
    }
}

function clearCommandLog() {
    const log = document.getElementById('commandLog');
    log.innerHTML = `
        <div class="text-center py-4">
            <i class="fas fa-terminal fa-2x mb-2 opacity-50"></i>
            <div>DICOM command output will appear here</div>
            <small class="text-muted">Run a query to see command logs</small>
        </div>
    `;
}

function addLogEntry(type, message, timestamp = null) {
    const log = document.getElementById('commandLog');
    const time = timestamp || new Date().toLocaleTimeString();
    
    // Clear placeholder if it exists
    if (log.querySelector('.text-center')) {
        log.innerHTML = '';
    }
    
    const logEntry = document.createElement('div');
    logEntry.className = `mb-1 ${type === 'error' ? 'text-danger' : type === 'success' ? 'text-success' : type === 'warning' ? 'text-warning' : 'text-info'}`;
    
    const icon = type === 'error' ? 'fa-exclamation-circle' : 
                type === 'success' ? 'fa-check-circle' : 
                type === 'warning' ? 'fa-exclamation-triangle' : 
                'fa-info-circle';
    
    logEntry.innerHTML = `
        <span class="text-muted">[${time}]</span> 
        <i class="fas ${icon}"></i> 
        ${message}
    `;
    
    log.appendChild(logEntry);
    
    // Auto-scroll to bottom
    const container = document.getElementById('commandLogContainer');
    container.scrollTop = container.scrollHeight;
}

function addCommandOutput(command, output, exitCode = 0) {
    const log = document.getElementById('commandLog');
    const time = new Date().toLocaleTimeString();
    
    // Clear placeholder if it exists
    if (log.querySelector('.text-center')) {
        log.innerHTML = '';
    }
    
    // Add command entry
    const commandEntry = document.createElement('div');
    commandEntry.className = 'mb-2';
    commandEntry.innerHTML = `
        <div class="text-muted">[${time}] <i class="fas fa-terminal"></i> <strong>Command:</strong></div>
        <div class="text-info ps-3 font-monospace" style="font-size: 0.65rem; line-height: 1.1;">${command}</div>
    `;
    log.appendChild(commandEntry);
    
    // Add output entry
    if (output) {
        const outputEntry = document.createElement('div');
        outputEntry.className = `mb-2 ${exitCode === 0 ? 'text-success' : 'text-danger'}`;
        outputEntry.innerHTML = `
            <div class="text-muted ps-3"><i class="fas fa-arrow-right"></i> <strong>Output:</strong></div>
            <pre class="ps-4 mb-0" style="font-size: 0.65rem; line-height: 1.1;">${output}</pre>
        `;
        log.appendChild(outputEntry);
    }
    
    // Add separator
    const separator = document.createElement('hr');
    separator.className = 'my-2 opacity-25';
    log.appendChild(separator);
    
    // Auto-scroll to bottom
    const container = document.getElementById('commandLogContainer');
    container.scrollTop = container.scrollHeight;
}

async function queryPacs() {
    const pacsId = document.getElementById('queryPacsSelect').value;
    const patientName = document.getElementById('patientNameQuery').value.trim();
    const patientId = document.getElementById('patientIdQuery').value.trim();
    const accession = document.getElementById('accessionQuery').value.trim();
    const studyUid = document.getElementById('studyUidQuery').value.trim();
    const seriesUid = document.getElementById('seriesUidQuery').value.trim();
    const daysAgo = parseInt(document.getElementById('daysAgo').value) || 0;
    const maxResults = parseInt(document.getElementById('maxResults').value) || 100;
    
    if (!pacsId) {
        alert('Please select a PACS server');
        return;
    }
    
    // Show loading
    const submitBtn = document.querySelector('#pacsQueryForm button[type="submit"]');
    const originalContent = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Querying...';
    submitBtn.disabled = true;
    
    // Clear previous results
    currentResults = [];
    document.getElementById('queryResults').innerHTML = `
        <div class="text-center py-3">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Searching...</span>
            </div>
            <div class="mt-2">Querying PACS server...</div>
        </div>
    `;
    
    // Add log entry
    const pacsName = document.getElementById('queryPacsSelect').selectedOptions[0].textContent;
    addLogEntry('info', `Starting PACS query on ${pacsName}`);
    
    // Build search criteria log
    const criteria = [];
    if (patientName) criteria.push(`Patient Name: ${patientName}`);
    if (patientId) criteria.push(`Patient ID: ${patientId}`);
    if (accession) criteria.push(`Accession: ${accession}`);
    if (studyUid) criteria.push(`Study UID: ${studyUid.substring(0, 40)}...`);
    if (seriesUid) criteria.push(`Series UID: ${seriesUid.substring(0, 40)}...`);
    if (daysAgo > 0) criteria.push(`Date range: Last ${daysAgo} days`);
    criteria.push(`Max results: ${maxResults}`);
    
    if (criteria.length > 0) {
        addLogEntry('info', `Search criteria: ${criteria.join(', ')}`);
    }
    
    try {
        const response = await fetch('/api/pacs/query', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                pacs_config_id: pacsId,
                patient_name: patientName,
                patient_id: patientId,
                accession_number: accession,
                study_uid: studyUid,
                series_uid: seriesUid,
                days_ago: daysAgo,
                max_results: maxResults
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            currentResults = data.results;
            currentQueryInfo = data.query_info;
            
            addLogEntry('success', `Query completed successfully - found ${data.results.length} result(s)`);
            
            // Add command output if available
            if (data.command_output) {
                addCommandOutput(data.command_output.command, data.command_output.output, data.command_output.exit_code);
            }
            
            displayResults(data.results, data.query_info);
        } else {
            addLogEntry('error', `Query failed: ${data.error}`);
            if (data.command_output) {
                addCommandOutput(data.command_output.command, data.command_output.output, data.command_output.exit_code);
            }
            displayError(data.error);
        }
    } catch (error) {
        addLogEntry('error', `Network error: ${error.message}`);
        displayError(`Network error: ${error.message}`);
    } finally {
        submitBtn.innerHTML = originalContent;
        submitBtn.disabled = false;
    }
}

function displayResults(results, queryInfo) {
    const container = document.getElementById('queryResults');
    const exportBtn = document.getElementById('exportBtn');
    
    if (results.length === 0) {
        container.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <strong>Query Results from ${queryInfo.pacs_name}</strong><br>
                Found 0 result(s) at ${queryInfo.query_level} level<br>
                <strong>Search Criteria:</strong> ${formatSearchCriteria(queryInfo.search_criteria)}
            </div>
            <div class="text-center py-4">
                <i class="fas fa-search fa-3x mb-3 opacity-25"></i>
                <h5>No Results Found</h5>
                <p class="text-muted">Try adjusting your search criteria or date range</p>
            </div>
        `;
        exportBtn.style.display = 'none';
        return;
    }
    
    // Show export button
    exportBtn.style.display = 'inline-block';
    
    // Create results summary
    const summaryHtml = `
        <div class="alert alert-info mb-3">
            <i class="fas fa-info-circle"></i>
            <strong>Query Results from ${queryInfo.pacs_name}</strong><br>
            Found ${results.length} result(s) at ${queryInfo.query_level} level<br>
            <strong>Search Criteria:</strong> ${formatSearchCriteria(queryInfo.search_criteria)}
        </div>
    `;
    
    // Create table
    const tableHtml = `
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="resultsTable">
                <thead class="table-dark">
                    <tr>
                        <th>PATIENT NAME</th>
                        <th>PATIENT ID</th>
                        <th>DATE</th>
                        <th>TIME</th>
                        <th>STUDY DESCRIPTION</th>
                        <th>ACCESSION</th>
                        <th>MODALITY</th>
                        <th>SERIES</th>
                        <th>IMAGES</th>
                        <th>STUDY UID</th>
                    </tr>
                </thead>
                <tbody>
                    ${results.map((result, index) => `
                        <tr onclick="showStudyDetails(${index})" style="cursor: pointer;" 
                            title="Click to view detailed study information" data-bs-toggle="tooltip">
                            <td>${result.patient_name || '-'}</td>
                            <td>${result.patient_id || '-'}</td>
                            <td>${result.study_date_formatted || result.study_date || '-'}</td>
                            <td>${result.study_time || '-'}</td>
                            <td>${result.study_description || '-'}</td>
                            <td>${result.accession_number || '-'}</td>
                            <td>
                                ${result.modality ? `<span class="badge bg-info">${result.modality}</span>` : '-'}
                            </td>
                            <td>
                                ${result.series_count ? `<span class="badge bg-primary">${result.series_count}</span>` : '-'}
                            </td>
                            <td>
                                ${result.instance_count ? `<span class="badge bg-secondary">${result.instance_count}</span>` : '-'}
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <small class="text-muted font-monospace me-2">
                                        ${result.study_uid ? result.study_uid.substring(0, 20) + '...' : '-'}
                                    </small>
                                    ${result.study_uid ? `
                                        <button class="btn btn-sm btn-outline-secondary" 
                                                onclick="copyToClipboard('${result.study_uid}', 'Study UID', event)"
                                                title="Copy full Study UID to clipboard">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
    
    container.innerHTML = summaryHtml + tableHtml;
    
    // Initialize tosijs for sorting and pagination
    if (window.tosijs) {
        setTimeout(() => {
            window.tosijs('#resultsTable', {
                pagination: {
                    enabled: true,
                    pageSize: 10
                },
                search: {
                    enabled: true,
                    placeholder: 'Search results...'
                },
                sort: {
                    enabled: true
                }
            });
        }, 100);
    }
}

function displayError(error) {
    const container = document.getElementById('queryResults');
    const exportBtn = document.getElementById('exportBtn');
    
    container.innerHTML = `
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Query Error</strong><br>
            ${error}
        </div>
        <div class="text-center py-4">
            <i class="fas fa-exclamation-triangle fa-3x mb-3 text-warning"></i>
            <h5>Query Failed</h5>
            <p class="text-muted">Please check the DICOM Command Log for details</p>
        </div>
    `;
    
    exportBtn.style.display = 'none';
}

function formatSearchCriteria(criteria) {
    const parts = [];
    if (criteria.patient_name) parts.push(`Patient Name: ${criteria.patient_name}`);
    if (criteria.patient_id) parts.push(`Patient ID: ${criteria.patient_id}`);
    if (criteria.accession_number) parts.push(`Accession: ${criteria.accession_number}`);
    if (criteria.study_uid) parts.push(`Study UID: ${criteria.study_uid.substring(0, 30)}... <button class="btn btn-sm btn-outline-secondary ms-1" onclick="copyToClipboard('${criteria.study_uid}', 'Study UID', event)" title="Copy full Study UID"><i class="fas fa-copy"></i></button>`);
    if (criteria.series_uid) parts.push(`Series UID: ${criteria.series_uid.substring(0, 30)}... <button class="btn btn-sm btn-outline-secondary ms-1" onclick="copyToClipboard('${criteria.series_uid}', 'Series UID', event)" title="Copy full Series UID"><i class="fas fa-copy"></i></button>`);
    if (criteria.days_ago > 0) parts.push(`Date range: Last ${criteria.days_ago} days`);
    
    return parts.length > 0 ? parts.join(', ') : 'All studies';
}

async function showStudyDetails(index) {
    let study = currentResults[index];
    if (!study) return;
    
    // Store the current study for C-MOVE operations
    currentStudyForCMove = study;
    
    // Add log entry for opening study details
    addLogEntry('info', `Opening study details for Study UID: ${study.study_uid.substring(0, 40)}...`);
    
    // Automatically query for series details if not already available
    if (!study.series_details || study.series_details.length === 0) {
        addLogEntry('info', 'Querying for series-level details...');
        await querySeriesDetailsForStudy(study.study_uid, index);
        // Re-fetch the updated study data after querying
        study = currentResults[index];
    }
    
    // Format dates
    const studyDate = study.study_date_formatted || study.study_date || 'Unknown';
    const studyTime = study.study_time || 'Unknown';
    
    // Build the detailed view HTML
    let detailsHtml = `
        <div class="row">
            <div class="col-md-6">
                <h6 class="border-bottom pb-2"><i class="fas fa-user"></i> Patient Information</h6>
                <dl class="row" style="font-size: 0.85rem;">
                    <dt class="col-sm-5">Patient Name:</dt>
                    <dd class="col-sm-7">${study.patient_name || 'Unknown'}</dd>
                    
                    <dt class="col-sm-5">Patient ID:</dt>
                    <dd class="col-sm-7">${study.patient_id || 'Unknown'}</dd>
                    
                    <dt class="col-sm-5">Birth Date:</dt>
                    <dd class="col-sm-7">${study.patient_birth_date || 'Not Available'}</dd>
                    
                    <dt class="col-sm-5">Sex:</dt>
                    <dd class="col-sm-7">${study.patient_sex || 'Not Available'}</dd>
                </dl>
            </div>
            
            <div class="col-md-6">
                <h6 class="border-bottom pb-2"><i class="fas fa-file-medical"></i> Study Information</h6>
                <dl class="row" style="font-size: 0.85rem;">
                    <dt class="col-sm-5">Study Date:</dt>
                    <dd class="col-sm-7">${studyDate}</dd>
                    
                    <dt class="col-sm-5">Study Time:</dt>
                    <dd class="col-sm-7">${studyTime}</dd>
                    
                    <dt class="col-sm-5">Accession:</dt>
                    <dd class="col-sm-7">${study.accession_number || 'Unknown'}</dd>
                    
                    <dt class="col-sm-5">Modality:</dt>
                    <dd class="col-sm-7">${study.modality ? `<span class="badge bg-info">${study.modality}</span>` : 'Unknown'}</dd>
                </dl>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-12">
                <h6 class="border-bottom pb-2"><i class="fas fa-info-circle"></i> Study Details</h6>
                <dl class="row">
                    <dt class="col-sm-3">Study Description:</dt>
                    <dd class="col-sm-9">${study.study_description || 'No description available'}</dd>
                    
                    <dt class="col-sm-3">Study Instance UID:</dt>
                    <dd class="col-sm-9">
                        <div class="d-flex align-items-start">
                            <small class="font-monospace text-break me-2" style="word-break: break-all;">
                                ${study.study_uid || 'Unknown'}
                            </small>
                            ${study.study_uid ? `
                                <button class="btn btn-sm btn-outline-secondary" 
                                        onclick="copyToClipboard('${study.study_uid}', 'Study UID', event)"
                                        title="Copy full Study UID to clipboard">
                                    <i class="fas fa-copy"></i>
                                </button>
                            ` : ''}
                        </div>
                    </dd>
                    
                    <dt class="col-sm-3">Referring Physician:</dt>
                    <dd class="col-sm-9">${study.referring_physician || 'Not Available'}</dd>
                    
                    <dt class="col-sm-3">Institution:</dt>
                    <dd class="col-sm-9">${study.institution_name || 'Not Available'}</dd>
                </dl>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-12">
                <h6 class="border-bottom pb-2"><i class="fas fa-layer-group"></i> Series</h6>
                <div class="table-responsive">
                    <table class="table table-sm" style="font-size: 0.8rem;">
                        <thead>
                            <tr>
                                <th style="width: 8%;">Series #</th>
                                <th style="width: 22%;">Description</th>
                                <th style="width: 35%;">Series UID</th>
                                <th style="width: 10%;">Modality</th>
                                <th style="width: 10%;">Images</th>
                                <th style="width: 15%;">Procedure Code</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${study.series_details && study.series_details.length > 0 ? 
                                study.series_details.map(series => `
                                    <tr>
                                        <td>${series.series_number || '-'}</td>
                                        <td>${series.series_description || '-'}</td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <small class="font-monospace text-truncate d-inline-block me-2" style="max-width: 250px;" 
                                                       title="${series.series_uid || '-'}">
                                                    ${series.series_uid ? series.series_uid.substring(0, 25) + '...' : '-'}
                                                </small>
                                                ${series.series_uid ? `
                                                                                                    <button class="btn btn-sm btn-outline-secondary" 
                                                        onclick="copyToClipboard('${series.series_uid}', 'Series UID', event)"
                                                        title="Copy full Series UID to clipboard">
                                                        <i class="fas fa-copy"></i>
                                                    </button>
                                                ` : ''}
                                            </div>
                                        </td>
                                        <td><span class="badge bg-info">${series.modality || study.modality || '-'}</span></td>
                                        <td><span class="badge bg-secondary">${series.instance_count || '-'}</span></td>
                                        <td>${series.procedure_code || series.series_description || '-'}</td>
                                    </tr>
                                `).join('') : 
                                `<tr>
                                    <td colspan="6" class="text-center">
                                        <small class="text-muted">
                                            Total Series: ${study.series_count || '0'} | 
                                            Total Images: ${study.instance_count || '0'}
                                        </small>
                                    </td>
                                </tr>`
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    
    // Update modal content
    document.getElementById('studyDetailsContent').innerHTML = detailsHtml;
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('studyDetailsModal'));
    modal.show();
}

async function querySeriesDetailsForStudy(studyUid, studyIndex) {
    try {
        // Query for series-level details
        const pacsId = document.getElementById('queryPacsSelect').value;
        const pacsName = document.getElementById('queryPacsSelect').selectedOptions[0].textContent;
        
        addLogEntry('info', `Performing series-level query on ${pacsName}`);
        
        const response = await fetch('/api/pacs/query-series', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                pacs_config_id: pacsId,
                study_uid: studyUid
            })
        });
        
        const data = await response.json();
        
        // Add command output to log if available
        if (data.command_output) {
            addCommandOutput(data.command_output.command, data.command_output.output, data.command_output.exit_code);
        }
        
        if (data.success && data.series_details) {
            addLogEntry('success', `Found ${data.series_details.length} series for study`);
            
            // Log each series found
            data.series_details.forEach(series => {
                addLogEntry('info', `Series ${series.series_number}: ${series.series_description || 'No description'} (${series.instance_count} images)`);
            });
            
            // Update the current result with series details
            if (studyIndex >= 0) {
                currentResults[studyIndex].series_details = data.series_details;
            }
        } else {
            addLogEntry('warning', 'No series details found or query failed');
        }
    } catch (error) {
        console.error('Error querying series details:', error);
        addLogEntry('error', `Failed to query series details: ${error.message}`);
    }
}

async function exportResults() {
    if (currentResults.length === 0) {
        alert('No results to export');
        return;
    }
    
    try {
        const response = await fetch('/api/dicom/export/csv', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                results: currentResults,
                query_info: currentQueryInfo
            })
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pacs_query_results_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.csv`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        } else {
            alert('Failed to export results');
        }
    } catch (error) {
        console.error('Export error:', error);
        alert('Error exporting results');
    }
}

function showCMoveDialog() {
    // Store the current study for C-MOVE
    if (!currentStudyForCMove) {
        alert('No study selected for C-MOVE');
        return;
    }
    
    // Load available PACS configs (excluding the source PACS)
    loadDestinationPacsConfigs();
    
    // Update study info display
    const studyInfo = `${currentStudyForCMove.patient_name} - ${currentStudyForCMove.study_description || 'No description'}<br>
                      Study UID: ${currentStudyForCMove.study_uid}<br>
                      Date: ${currentStudyForCMove.study_date_formatted || currentStudyForCMove.study_date}`;
    document.getElementById('cMoveStudyInfo').innerHTML = studyInfo;
    
    // Show the C-MOVE modal with proper z-index handling
    const modal = new bootstrap.Modal(document.getElementById('cMoveModal'));
    modal.show();
    
    // Ensure the C-MOVE modal and its backdrop appear above the study details modal
    document.getElementById('cMoveModal').addEventListener('shown.bs.modal', function() {
        // Set higher z-index for the modal and backdrop
        this.style.zIndex = 1070;
        const backdrop = document.querySelector('.modal-backdrop:last-child');
        if (backdrop) {
            backdrop.style.zIndex = 1065;
        }
    });
}

async function loadDestinationPacsConfigs() {
    try {
        const response = await fetch('/api/pacs/configs');
        const data = await response.json();
        
        const select = document.getElementById('destinationPacsSelect');
        select.innerHTML = '';
        
        if (data.success && data.configs.length > 0) {
            // Add default option
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Select destination PACS...';
            select.appendChild(defaultOption);
            
            // Get current source PACS ID to exclude it
            const sourcePacsId = document.getElementById('queryPacsSelect').value;
            
            data.configs.forEach(config => {
                // Exclude the source PACS from destination options
                if (config.id !== sourcePacsId) {
                    const option = document.createElement('option');
                    option.value = config.id;
                    option.textContent = `${config.name} (${config.host}:${config.port})`;
                    select.appendChild(option);
                }
            });
            
            if (select.children.length === 1) {
                // Only the default option exists (no other PACS available)
                select.innerHTML = '<option value="">No other PACS servers available</option>';
            }
        } else {
            select.innerHTML = '<option value="">No PACS configurations available</option>';
        }
    } catch (error) {
        console.error('Error loading destination PACS configs:', error);
        document.getElementById('destinationPacsSelect').innerHTML = '<option value="">Error loading PACS configs</option>';
    }
}

async function executeCMove() {
    const destinationPacsId = document.getElementById('destinationPacsSelect').value;
    const sourcePacsId = document.getElementById('queryPacsSelect').value;
    
    if (!destinationPacsId) {
        alert('Please select a destination PACS server');
        return;
    }
    
    if (!currentStudyForCMove) {
        alert('No study selected for C-MOVE');
        return;
    }
    
    // Show loading state
    const cMoveBtn = document.querySelector('#cMoveModal .btn-primary');
    const originalContent = cMoveBtn.innerHTML;
    cMoveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Moving...';
    cMoveBtn.disabled = true;
    
    // Get PACS names for logging
    const sourcePacsName = document.getElementById('queryPacsSelect').selectedOptions[0].textContent;
    const destinationPacsName = document.getElementById('destinationPacsSelect').selectedOptions[0].textContent;
    
    // Add log entry
    addLogEntry('info', `Starting C-MOVE operation from ${sourcePacsName} to ${destinationPacsName}`);
    addLogEntry('info', `Moving study: ${currentStudyForCMove.study_uid.substring(0, 40)}...`);
    
    try {
        const response = await fetch('/api/pacs/c-move', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                source_pacs_id: sourcePacsId,
                destination_pacs_id: destinationPacsId,
                study_uid: currentStudyForCMove.study_uid,
                patient_id: currentStudyForCMove.patient_id
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            addLogEntry('success', `C-MOVE operation completed successfully`);
            
            // Add command output if available
            if (data.command_output) {
                addCommandOutput(data.command_output.command, data.command_output.output, data.command_output.exit_code);
            }
            
            // Close the C-MOVE modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('cMoveModal'));
            modal.hide();
            
            // Show success message
            alert('C-MOVE operation completed successfully. Check the DICOM Command Log for details.');
        } else {
            addLogEntry('error', `C-MOVE operation failed: ${data.error}`);
            
            if (data.command_output) {
                addCommandOutput(data.command_output.command, data.command_output.output, data.command_output.exit_code);
            }
            
            alert(`C-MOVE operation failed: ${data.error}`);
        }
    } catch (error) {
        addLogEntry('error', `C-MOVE network error: ${error.message}`);
        alert(`Network error during C-MOVE: ${error.message}`);
    } finally {
        cMoveBtn.innerHTML = originalContent;
        cMoveBtn.disabled = false;
    }
}

// Utility function to copy text to clipboard
async function copyToClipboard(text, label, event) {
    // Prevent event from bubbling up to the row
    if (event) {
        event.stopPropagation();
        event.preventDefault();
    }
    
    try {
        await navigator.clipboard.writeText(text);
        
        // Show success feedback
        const button = event.target.closest('button');
        const originalContent = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i>';
        button.classList.remove('btn-outline-secondary');
        button.classList.add('btn-success');
        
        // Add log entry
        addLogEntry('success', `Copied ${label} to clipboard`);
        
        // Reset button after 2 seconds
        setTimeout(() => {
            button.innerHTML = originalContent;
            button.classList.remove('btn-success');
            button.classList.add('btn-outline-secondary');
        }, 2000);
        
    } catch (err) {
        console.error('Failed to copy to clipboard:', err);
        
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        
        // Show success feedback
        const button = event.target.closest('button');
        const originalContent = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i>';
        button.classList.remove('btn-success');
        button.classList.add('btn-outline-secondary');
        
        addLogEntry('success', `Copied ${label} to clipboard (fallback method)`);
        
        setTimeout(() => {
            button.innerHTML = originalContent;
            button.classList.remove('btn-success');
            button.classList.add('btn-outline-secondary');
        }, 2000);
    }
}
</script>
{% endblock %}