{% extends "base.html" %}

{% block title %}PACS - DICOM Fabricator{% endblock %}

{% block head %}
<!-- Custom table implementation - no external dependencies -->
<style>
/* Custom table styling */
.custom-table {
    width: 100%;
    border-collapse: collapse;
}

.custom-table th,
.custom-table td {
    padding: 8px 12px;
    text-align: left;
    border-bottom: 1px solid #dee2e6;
}

.custom-table th {
    background-color: #f8f9fa;
    font-weight: 600;
    cursor: pointer;
    user-select: none;
    position: relative;
    padding-right: 25px;
}

.custom-table th.sortable::after {
    content: "⇅";
    position: absolute;
    right: 8px;
    opacity: 0.5;
    font-size: 0.8rem;
}

.custom-table th.sortable.sort-asc::after {
    content: "↑";
    opacity: 1;
}

.custom-table th.sortable.sort-desc::after {
    content: "↓";
    opacity: 1;
}

.custom-table tbody tr:hover {
    background-color: rgba(0,0,0,.075);
}

/* Ensure table responsiveness */
.table-responsive {
    overflow-x: auto;
}

/* Status indicators */
.status-indicator {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 8px;
}

.status-online {
    background-color: #28a745;
}

.status-offline {
    background-color: #dc3545;
}

.status-unknown {
    background-color: #ffc107;
}
</style>

<script>
// Custom table implementation
class CustomTable {
    constructor(selector, options = {}) {
        this.table = document.querySelector(selector);
        this.options = options;
        this.data = [];
        this.currentSort = { column: null, direction: 'asc' };
        
        if (this.table) {
            this.init();
        }
    }
    
    init() {
        // Add custom table class
        this.table.classList.add('custom-table');
        
        // Make headers sortable
        const headers = this.table.querySelectorAll('th');
        headers.forEach((header, index) => {
            if (header.textContent.trim() !== '') {
                header.classList.add('sortable');
                header.addEventListener('click', () => this.sortByColumn(index));
            }
        });
    }
    
    sortByColumn(columnIndex) {
        const headers = this.table.querySelectorAll('th');
        const header = headers[columnIndex];
        
        // Clear previous sort indicators
        headers.forEach(h => {
            h.classList.remove('sort-asc', 'sort-desc');
        });
        
        // Determine sort direction
        if (this.currentSort.column === columnIndex) {
            this.currentSort.direction = this.currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
            this.currentSort.column = columnIndex;
            this.currentSort.direction = 'asc';
        }
        
        // Add sort indicator
        header.classList.add(`sort-${this.currentSort.direction}`);
        
        // Sort the table
        this.sortTable(columnIndex, this.currentSort.direction);
    }
    
    sortTable(columnIndex, direction) {
        const tbody = this.table.querySelector('tbody');
        if (!tbody) return;
        
        const rows = Array.from(tbody.querySelectorAll('tr'));
        
        rows.sort((a, b) => {
            const aValue = a.cells[columnIndex]?.textContent.trim() || '';
            const bValue = b.cells[columnIndex]?.textContent.trim() || '';
            
            // Try to convert to numbers for numeric sorting
            const aNum = parseFloat(aValue);
            const bNum = parseFloat(bValue);
            
            if (!isNaN(aNum) && !isNaN(bNum)) {
                return direction === 'asc' ? aNum - bNum : bNum - aNum;
            }
            
            // String sorting
            if (direction === 'asc') {
                return aValue.localeCompare(bValue);
            } else {
                return bValue.localeCompare(aValue);
            }
        });
        
        // Reorder rows
        rows.forEach(row => tbody.appendChild(row));
    }
    
    setData(data) {
        this.data = data;
        // This method can be extended to populate the table with data
        console.log('Table data set:', data.length, 'rows');
    }
    
    refresh() {
        // Refresh the table display
        console.log('Table refreshed');
    }
    
    destroy() {
        // Clean up event listeners
        const headers = this.table.querySelectorAll('th');
        headers.forEach(header => {
            header.classList.remove('sortable', 'sort-asc', 'sort-desc');
        });
        this.table.classList.remove('custom-table');
    }
}

// Global table instance
let pacsTable = null;

// Initialize table when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing custom table implementation');
    
    // Load PACS configurations (table will be initialized after data loads)
    loadPacsConfigurations();
});
</script>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-server"></i> PACS</h2>
        <p class="text-muted">Manage PACS server configurations for sending and querying DICOM studies</p>
    </div>
</div>


        <!-- Actions -->
        <div class="row mb-3">
            <div class="col-12">
                <button class="btn btn-success" onclick="showCreateModal()">
                    <i class="fas fa-plus"></i> Add New PACS
                </button>
                <button class="btn btn-outline-secondary ms-2" onclick="refreshPacsTable()" 
                        data-bs-toggle="tooltip" title="Refresh PACS configurations">
                    <i class="fas fa-sync"></i> Refresh
                </button>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-bolt"></i> Quick Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="d-grid">
                                    <a href="/query-pacs" class="btn btn-primary btn-lg">
                                        <i class="fas fa-search"></i> Query PACS Studies
                                    </a>
                                </div>
                                <p class="text-muted small mt-2">Search and query DICOM studies on PACS servers with advanced filtering</p>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="d-grid">
                                    <a href="/generator" class="btn btn-success btn-lg">
                                        <i class="fas fa-file-medical"></i> Generate & Send Studies
                                    </a>
                                </div>
                                <p class="text-muted small mt-2">Create synthetic DICOM studies and send them to PACS servers</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PACS Configurations Table -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-list"></i> PACS Configurations</h5>
                    </div>
                    <div class="card-body">
                        <div id="pacsTableContainer">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <div class="mt-2">Loading PACS configurations...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create/Edit PACS Modal -->
    <div class="modal fade" id="pacsConfigModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="pacsModalTitle">Add New PACS Configuration</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="pacsConfigForm">
                        <input type="hidden" id="configId" name="configId">
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="configName" class="form-label">Name *</label>
                                    <input type="text" class="form-control" id="configName" name="name" required>
                                    <div class="form-text">Descriptive name for this PACS</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="configHost" class="form-label">Host *</label>
                                    <input type="text" class="form-control" id="configHost" name="host" required>
                                    <div class="form-text">IP address or hostname</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="configPort" class="form-label">Port *</label>
                                    <input type="number" class="form-control" id="configPort" name="port" min="1" max="65535" required>
                                    <div class="form-text">DICOM port (typically 4242)</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="configAEC" class="form-label">PACS AEC *</label>
                                    <input type="text" class="form-control" id="configAEC" name="aec" maxlength="16" required>
                                    <div class="form-text">Called Application Entity Title</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="configAETFind" class="form-label">C-FIND AET *</label>
                                    <input type="text" class="form-control" id="configAETFind" name="aet_find" maxlength="16" required>
                                    <div class="form-text">AE for C-FIND queries</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="configAETStore" class="form-label">C-STORE AET *</label>
                                    <input type="text" class="form-control" id="configAETStore" name="aet_store" maxlength="16" required>
                                    <div class="form-text">AE for C-STORE operations</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="configAETEcho" class="form-label">C-ECHO AET *</label>
                                    <input type="text" class="form-control" id="configAETEcho" name="aet_echo" maxlength="16" required>
                                    <div class="form-text">AE for C-ECHO tests</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Options</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="configDefault" name="is_default">
                                        <label class="form-check-label" for="configDefault">
                                            Set as default PACS
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="configActive" name="is_active" checked>
                                        <label class="form-check-label" for="configActive">
                                            Active
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="configEnvironment" class="form-label">Environment</label>
                            <select class="form-select" id="configEnvironment" name="environment">
                                <option value="test">Test</option>
                                <option value="production">Production</option>
                                <option value="both">Both</option>
                            </select>
                            <div class="form-text">Environment classification for this PACS</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="configDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="configDescription" name="description" rows="2"></textarea>
                            <div class="form-text">Optional description or notes</div>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>AET/AEC Info:</strong> Application Entity Titles are typically 1-16 characters, 
                            alphanumeric plus some symbols. Common values: DICOMFAB, ORTHANC, TESTPACS.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="savePacsConfig()">
                        <i class="fas fa-save"></i> <span id="saveButtonText">Save Configuration</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Connection Modal -->
    <div class="modal fade" id="testConnectionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Test PACS Connection</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="testConnectionContent">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Testing connection...</span>
                            </div>
                            <div class="mt-2">Testing connection...</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- C-MOVE Routing Modal -->
    <div class="modal fade" id="routingModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="routingModalTitle">C-MOVE Routing Configuration</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="padding: 1rem;">
                    <div id="routingContent">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading routing table...</span>
                            </div>
                            <div class="mt-2">Loading routing table...</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveRoutingTable()">
                        <i class="fas fa-save"></i> Save Routing Table
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- PACS Diagram Modal -->
    <div class="modal fade" id="pacsDiagramModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="pacsDiagramModalTitle">PACS Context Diagram</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="padding: 1rem;">
                    <div id="pacsDiagramContent">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading diagram...</span>
                            </div>
                            <p class="mt-2">Loading PACS diagram...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let queryResultsTable;
        let currentEditId = null;
        let queryResults = [];

        async function loadPacsConfigurations() {
            try {
                const response = await fetch('/api/pacs/configs');
                const data = await response.json();
                
                if (data.success) {
                    displayPacsTable(data.configs);
                } else {
                    document.getElementById('pacsTableContainer').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i> Error loading PACS configurations: ${data.error}
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('pacsTableContainer').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i> Network error loading PACS configurations
                    </div>
                `;
            }
        }

        function displayPacsTable(configs) {
            if (configs.length === 0) {
                document.getElementById('pacsTableContainer').innerHTML = `
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-server fa-3x mb-3"></i>
                        <h5>No PACS Configurations</h5>
                        <p>Click "Add New PACS" to create your first configuration</p>
                    </div>
                `;
                return;
            }

            const tableHtml = `
                <div class="table-responsive" style="max-width: 95vw;">
                    <table id="pacsTable" class="table table-striped table-hover table-sm">
                        <thead>
                            <tr>
                                <th style="width: 11%;">Name</th>
                                <th style="width: 13%;">Host:Port</th>
                                <th style="width: 7%;">C-FIND</th>
                                <th style="width: 7%;">C-STORE</th>
                                <th style="width: 7%;">C-ECHO</th>
                                <th style="width: 7%;">PACS AEC</th>
                                <th style="width: 8%;">C-MOVE Routes</th>
                                <th style="width: 10%;">Description</th>
                                <th style="width: 5%;">Status</th>
                                <th style="width: 5%;">Default</th>
                                <th style="width: 7%;">Last Tested</th>
                                <th style="width: 10%;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${configs.map(config => {
                                const testStatusBadge = config.test_status === 'success' ? 
                                    '<span class="badge bg-success"><i class="fas fa-check"></i> Pass</span>' :
                                    config.test_status === 'failed' ?
                                    '<span class="badge bg-danger"><i class="fas fa-times"></i> Fail</span>' :
                                    '<span class="badge bg-secondary"><i class="fas fa-question"></i> Unknown</span>';
                                
                                const lastTested = config.last_tested ? 
                                    new Date(config.last_tested).toLocaleString() : 
                                    'Never';
                                
                                // Apply environment color coding
                                const envColor = config.environment === 'production' ? '#6f42c1' : 
                                               config.environment === 'test' ? '#198754' : '#6c757d';
                                const envBadge = config.environment ? 
                                    `<span class="badge" style="background-color: ${envColor}; color: white; font-size: 0.7rem; margin-left: 5px;">${config.environment}</span>` : '';
                                
                                return `
                                    <tr>
                                        <td>
                                            <strong style="color: ${envColor};">${config.name}</strong>
                                            ${envBadge}
                                            ${config.is_active ? '' : '<br><small class="text-muted">(Inactive)</small>'}
                                        </td>
                                        <td><code>${config.host}:${config.port}</code></td>
                                        <td><code>${config.aet_find || '-'}</code></td>
                                        <td><code>${config.aet_store || '-'}</code></td>
                                        <td><code>${config.aet_echo || '-'}</code></td>
                                        <td><code>${config.aec}</code></td>
                                        <td>
                                            ${(() => {
                                                const routes = config.move_routing || {};
                                                const routeCount = Object.keys(routes).filter(destId => routes[destId] && routes[destId].trim()).length;
                                                if (routeCount === 0) {
                                                    return '<span class="text-muted">None</span>';
                                                } else {
                                                    return `<span class="badge bg-info" title="Configured C-MOVE routes to ${routeCount} destination PACS">${routeCount}</span>`;
                                                }
                                            })()}
                                        </td>
                                        <td>
                                            <div class="text-truncate" style="max-width: 120px;" title="${config.description || ''}">
                                                ${config.description || '-'}
                                            </div>
                                        </td>
                                        <td>${testStatusBadge}</td>
                                        <td>
                                            ${config.is_default ? '<span class="badge bg-warning"><i class="fas fa-star"></i> Default</span>' : '-'}
                                        </td>
                                        <td>
                                            <small>${lastTested}</small>
                                            ${config.test_message ? `<br><small class="text-muted" title="${config.test_message}">📝</small>` : ''}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button class="btn btn-outline-info" onclick="testConnection('${config.id}')" 
                                                        data-bs-toggle="tooltip" title="Test PACS connection">
                                                    <i class="fas fa-sync-alt"></i>
                                                </button>
                                                <button class="btn btn-outline-primary" onclick="editConfig('${config.id}')" 
                                                        data-bs-toggle="tooltip" title="Edit configuration">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-outline-secondary" onclick="editRouting('${config.id}')" 
                                                        data-bs-toggle="tooltip" title="Edit C-MOVE routing">
                                                    <i class="fas fa-route"></i>
                                                </button>
                                                <button class="btn btn-outline-info" onclick="showPacsDiagram('${config.id}')" 
                                                        data-bs-toggle="tooltip" title="View PACS diagram">
                                                    <i class="fas fa-project-diagram"></i>
                                                </button>
                                                <button class="btn btn-outline-danger" onclick="deleteConfig('${config.id}', '${config.name}')" 
                                                        data-bs-toggle="tooltip" title="Delete configuration">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('pacsTableContainer').innerHTML = tableHtml;

            // Initialize the custom table after the HTML is rendered
            const tableElement = document.querySelector('#pacsTable');
            if (tableElement) {
                if (pacsTable) {
                    pacsTable.destroy(); // Clean up previous instance
                }
                pacsTable = new CustomTable('#pacsTable');
                pacsTable.setData(configs);
                console.log('Custom table initialized and data set successfully');
            } else {
                console.warn('Table element not found, cannot initialize custom table.');
            }
    }

    // Add event listeners and initialization
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });
        
        // Start automatic PACS testing after initial load
        setTimeout(() => {
            testAllPacsConfigurations();
        }, 1000);
    });

        function showCreateModal() {
            currentEditId = null;
            document.getElementById('pacsModalTitle').textContent = 'Add New PACS Configuration';
            document.getElementById('saveButtonText').textContent = 'Save Configuration';
            document.getElementById('pacsConfigForm').reset();
            document.getElementById('configActive').checked = true;
            
            const modal = new bootstrap.Modal(document.getElementById('pacsConfigModal'));
            modal.show();
        }

        async function editConfig(configId) {
            try {
                const response = await fetch(`/api/pacs/configs/${configId}`);
                const data = await response.json();
                
                if (data.success) {
                    currentEditId = configId;
                    const config = data.config;
                    
                    document.getElementById('pacsModalTitle').textContent = 'Edit PACS Configuration';
                    document.getElementById('saveButtonText').textContent = 'Update Configuration';
                    
                    document.getElementById('configName').value = config.name;
                    document.getElementById('configHost').value = config.host;
                    document.getElementById('configPort').value = config.port;
                    document.getElementById('configAETFind').value = config.aet_find || '';
                    document.getElementById('configAETStore').value = config.aet_store || '';
                    document.getElementById('configAETEcho').value = config.aet_echo || '';
                    document.getElementById('configAEC').value = config.aec;
                    document.getElementById('configEnvironment').value = config.environment || 'test';
                    document.getElementById('configDescription').value = config.description || '';
                    document.getElementById('configDefault').checked = config.is_default;
                    document.getElementById('configActive').checked = config.is_active;
                    
                    const modal = new bootstrap.Modal(document.getElementById('pacsConfigModal'));
                    modal.show();
                } else {
                    alert('Error loading configuration: ' + data.error);
                }
            } catch (error) {
                alert('Network error loading configuration');
            }
        }

        async function savePacsConfig() {
            const form = document.getElementById('pacsConfigForm');
            const formData = new FormData(form);
            
            const configData = {
                name: formData.get('name'),
                host: formData.get('host'),
                port: parseInt(formData.get('port')),
                aet_find: formData.get('aet_find'),
                aet_store: formData.get('aet_store'),
                aet_echo: formData.get('aet_echo'),
                aec: formData.get('aec'),
                environment: formData.get('environment'),
                description: formData.get('description'),
                is_default: document.getElementById('configDefault').checked,
                is_active: document.getElementById('configActive').checked
            };

            try {
                const url = currentEditId ? `/api/pacs/configs/${currentEditId}` : '/api/pacs/configs';
                const method = currentEditId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(configData)
                });

                const data = await response.json();

                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('pacsConfigModal')).hide();
                    loadPacsConfigurations();
                } else {
                    alert('Error saving configuration: ' + data.error);
                }
            } catch (error) {
                alert('Network error saving configuration');
            }
        }

        async function deleteConfig(configId, configName) {
            if (!confirm(`Are you sure you want to delete the PACS configuration "${configName}"?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/pacs/configs/${configId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    loadPacsConfigurations();
                } else {
                    alert('Error deleting configuration: ' + data.error);
                }
            } catch (error) {
                alert('Network error deleting configuration');
            }
        }


        function refreshPacsTable() {
            loadPacsConfigurations();
        }


        async function testAllPacsConfigurations() {
            try {
                // Get all PACS configurations
                const response = await fetch('/api/pacs/configs');
                const data = await response.json();
                
                if (data.success && data.configs.length > 0) {
                    console.log(`Starting automatic testing of ${data.configs.length} PACS configurations...`);
                    
                    // Test each configuration with a delay to avoid overwhelming the network
                    for (let i = 0; i < data.configs.length; i++) {
                        const config = data.configs[i];
                        
                        // Only test active configurations
                        if (config.is_active) {
                            console.log(`Testing PACS: ${config.name}`);
                            
                            // Update UI to show testing in progress
                            updatePacsTestingStatus(config.id, 'testing');
                            
                            try {
                                await testConnection(config.id, false); // false = don't show modal
                                
                                // Add delay between tests to prevent overwhelming the server
                                if (i < data.configs.length - 1) {
                                    await new Promise(resolve => setTimeout(resolve, 2000));
                                }
                            } catch (error) {
                                console.error(`Error testing PACS ${config.name}:`, error);
                            }
                        }
                    }
                    
                    console.log('Automatic PACS testing completed');
                    
                    // Refresh table after all tests
                    loadPacsConfigurations();
                }
            } catch (error) {
                console.error('Error during automatic PACS testing:', error);
            }
        }

        function updatePacsTestingStatus(configId, status) {
            // Find the table row for this config and update the status badge
            const table = document.getElementById('pacsTable');
            if (!table) return;
            
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const testButton = row.querySelector(`button[onclick*="${configId}"]`);
                if (testButton) {
                    const statusCell = row.cells[8]; // Status column
                    if (statusCell) {
                        if (status === 'testing') {
                            statusCell.innerHTML = '<span class="badge bg-warning"><i class="fas fa-spinner fa-spin"></i> Testing</span>';
                        }
                    }
                }
            });
        }

        async function testConnection(configId, showModal = true) {
            if (showModal) {
                const modal = new bootstrap.Modal(document.getElementById('testConnectionModal'));
                document.getElementById('testConnectionContent').innerHTML = `
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Testing connection...</span>
                        </div>
                        <div class="mt-2">Testing connection...</div>
                    </div>
                `;
                modal.show();
            }

            try {
                const response = await fetch(`/api/pacs/configs/${configId}/test`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (showModal) {
                    if (data.success) {
                        document.getElementById('testConnectionContent').innerHTML = `
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle"></i> <strong>Connection Successful!</strong><br>
                                ${data.message}
                            </div>
                            ${data.output ? `<div class="mt-3"><h6>Output:</h6><pre class="bg-light p-2 rounded"><code>${data.output}</code></pre></div>` : ''}
                        `;
                    } else {
                        document.getElementById('testConnectionContent').innerHTML = `
                            <div class="alert alert-danger">
                                <i class="fas fa-times-circle"></i> <strong>Connection Failed!</strong><br>
                                ${data.error}
                            </div>
                        `;
                    }
                }

                // Always refresh the table to show updated test status
                if (showModal) {
                    // Small delay before refreshing to let the test result persist in backend
                    setTimeout(() => {
                        loadPacsConfigurations();
                    }, 1000);
                }

                return data.success;

            } catch (error) {
                if (showModal) {
                    document.getElementById('testConnectionContent').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i> <strong>Network Error!</strong><br>
                            Could not test connection: ${error.message}
                        </div>
                    `;
                }
                return false;
            }
        }

        let currentRoutingConfigId = null;

        async function editRouting(configId) {
            currentRoutingConfigId = configId;
            
            try {
                // Get the PACS configuration
                const response = await fetch(`/api/pacs/configs/${configId}`);
                const data = await response.json();
                
                if (data.success) {
                    const config = data.config;
                    document.getElementById('routingModalTitle').textContent = `C-MOVE Routing for ${config.name || 'Unknown PACS'}`;
                    
                    // Get all PACS configurations for the routing table
                    const allConfigsResponse = await fetch('/api/pacs/configs');
                    const allConfigsData = await allConfigsResponse.json();
                    
                    if (allConfigsData.success) {
                        displayRoutingTable(config, allConfigsData.configs);
                        
                        const modal = new bootstrap.Modal(document.getElementById('routingModal'));
                        modal.show();
                    } else {
                        alert('Error loading PACS configurations: ' + allConfigsData.error);
                    }
                } else {
                    alert('Error loading configuration: ' + data.error);
                }
            } catch (error) {
                console.error('Error in editRouting:', error);
                alert('Network error loading configuration: ' + error.message);
            }
        }

        function displayRoutingTable(sourceConfig, allConfigs) {
            try {
                const routingTableHtml = `
                                    <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>C-MOVE Routing:</strong> Configure the AE titles that should use when performing C-MOVE operations to each of the potential destination PACS listed below. Leave blank if C-MOVE is not supported to that destination.
                </div>
                    
                    <div class="table-responsive">
                        <table class="table table-striped table-sm table-compact">
                            <thead>
                                <tr>
                                    <th style="width: 30%;">Destination PACS</th>
                                    <th style="width: 15%;">Environment</th>
                                    <th style="width: 35%;">C-MOVE AE Title</th>
                                    <th style="width: 20%;">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${allConfigs
                                    .filter(config => config.id !== sourceConfig.id)
                                    .map(destConfig => {
                                        const currentAE = (sourceConfig.move_routing && sourceConfig.move_routing[destConfig.id]) || '';
                                        const envColor = destConfig.environment === 'prod' ? '#6f42c1' : 
                                                       destConfig.environment === 'test' ? '#198754' : '#6c757d';
                                        
                                        return `
                                            <tr style="font-size: 0.9rem;">
                                                <td style="padding: 0.5rem;">
                                                    <strong style="color: ${envColor}; font-size: 0.9rem;">${destConfig.name || 'Unknown'}</strong>
                                                    <br><small class="text-muted" style="font-size: 0.75rem;">${destConfig.host || 'localhost'}:${destConfig.port || '4242'}</small>
                                                </td>
                                                <td style="padding: 0.5rem;">
                                                    <span class="badge" style="background-color: ${envColor}; color: white; font-size: 0.65rem;">
                                                        ${destConfig.environment || 'unknown'}
                                                    </span>
                                                </td>
                                                <td style="padding: 0.5rem;">
                                                    <input type="text" 
                                                           class="form-control form-control-sm" 
                                                           id="routing_${destConfig.id}" 
                                                           value="${currentAE}" 
                                                           maxlength="16"
                                                           placeholder="AE title or leave blank"
                                                           style="font-size: 0.85rem;">
                                                </td>
                                                <td style="padding: 0.5rem;">
                                                    ${currentAE ? 
                                                        '<span class="badge bg-success" style="font-size: 0.65rem;">Configured</span>' : 
                                                        '<span class="badge bg-secondary" style="font-size: 0.65rem;">Not configured</span>'
                                                    }
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                document.getElementById('routingContent').innerHTML = routingTableHtml;
            } catch (error) {
                console.error('Error in displayRoutingTable:', error);
                document.getElementById('routingContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        Error loading routing table: ${error.message}
                    </div>
                `;
            }
        }

        async function saveRoutingTable() {
            if (!currentRoutingConfigId) return;
            
            try {
                // Collect routing updates from the form
                const routingUpdates = {};
                const inputs = document.querySelectorAll('#routingContent input[type="text"]');
                
                inputs.forEach(input => {
                    const destConfigId = input.id.replace('routing_', '');
                    routingUpdates[destConfigId] = input.value.trim();
                });
                
                // Send updates to the server
                const response = await fetch(`/api/pacs/configs/${currentRoutingConfigId}/routing`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ routing_updates: routingUpdates })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('routingModal')).hide();
                    loadPacsConfigurations(); // Refresh the main table
                } else {
                    alert('Error saving routing table: ' + data.error);
                }
            } catch (error) {
                alert('Network error saving routing table');
            }
        }

        // PACS Diagram Functions
        async function showPacsDiagram(configId) {
            try {
                console.log('Opening PACS diagram for config:', configId);
                
                // Show modal with loading state
                const modal = new bootstrap.Modal(document.getElementById('pacsDiagramModal'));
                document.getElementById('pacsDiagramModalTitle').textContent = 'PACS Context Diagram';
                document.getElementById('pacsDiagramContent').innerHTML = `
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading diagram...</span>
                        </div>
                        <p class="mt-2">Loading PACS diagram...</p>
                    </div>
                `;
                modal.show();

                            // Load all PACS configurations
            const response = await fetch('/api/pacs/configs');
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('PACS configs response:', data);
                
                if (data.success) {
                    const currentPacs = data.configs.find(c => c.id === configId);
                    if (currentPacs) {
                        generatePacsDiagram(currentPacs, data.configs);
                    } else {
                        document.getElementById('pacsDiagramContent').innerHTML = `
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle"></i> PACS configuration not found
                            </div>
                        `;
                    }
                } else {
                    document.getElementById('pacsDiagramContent').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i> Error loading PACS configurations: ${data.error}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('PACS Diagram Error:', error);
                document.getElementById('pacsDiagramContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i> Error loading PACS configurations: ${error.message}
                        <br><small>Check browser console for details</small>
                    </div>
                `;
            }
        }

        function generatePacsDiagram(currentPacs, allConfigs) {
            const svgWidth = 1000;
            const svgHeight = 600;
            const centerX = svgWidth / 2;
            const centerY = svgHeight / 2;
            
            // Calculate positions with proper spacing to avoid overlap
            const appX = 50;
            const appWidth = 100;
            const interfacesX = 200;  // 50px gap after app
            const interfacesWidth = 150;
            const pacsX = 400;  // 50px gap after interfaces
            const pacsBoxWidth = 200;
            const pacsBoxHeight = 120;
            const rightStartX = 650;  // 50px gap after pacs
            
            // Get move routes first
            const moveRoutes = Object.entries(currentPacs.move_routing || {})
                .filter(([destId, aeTitle]) => aeTitle && aeTitle.trim())
                .map(([destId, aeTitle]) => {
                    const destPacs = allConfigs.find(c => c.id === destId);
                    return {
                        destId,
                        aeTitle,
                        destPacs: destPacs || { name: 'Unknown PACS', environment: 'unknown' }
                    };
                });

            // Outbound AEs container dimensions (only around the C-MOVE AE boxes)
            const outboundAEX = rightStartX - 20; // Start slightly before the first AE box
            const outboundAEWidth = 160; // Width to encompass AE box (120) + padding (20+20)
            const outboundAEY = centerY - 120; // Start above the first route
            const outboundAEHeight = (moveRoutes.length > 0 ? moveRoutes.length * 80 : 0) + 160; // Dynamic height + padding for title

            // Create SVG
            const svg = `
                <svg width="${svgWidth}" height="${svgHeight}" xmlns="http://www.w3.org/2000/svg" style="border: 1px solid #ddd; background: #f8f9fa;">
                    <!-- Background grid -->
                    <defs>
                        <pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse">
                            <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#e9ecef" stroke-width="0.5"/>
                        </pattern>
                    </defs>
                    <rect width="100%" height="100%" fill="url(#grid)" />
                    
                    <!-- DICOM Fabricator App -->
                    <g id="dicom-app">
                        <rect x="${appX}" y="${centerY - 40}" width="${appWidth}" height="80" 
                              fill="white" stroke="#6c757d" stroke-width="2" rx="10" />
                        <text x="${appX + appWidth/2}" y="${centerY - 20}" text-anchor="middle" 
                              font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#6c757d">
                            DICOM Fabricator
                        </text>
                        <text x="${appX + appWidth/2}" y="${centerY - 5}" text-anchor="middle" 
                              font-family="Arial, sans-serif" font-size="9" fill="#6c757d">
                            Application
                        </text>
                        <text x="${appX + appWidth/2}" y="${centerY + 10}" text-anchor="middle" 
                              font-family="Arial, sans-serif" font-size="9" fill="#6c757d">
                            AE: DICOMFAB
                        </text>
                        <text x="${appX + appWidth/2}" y="${centerY + 25}" text-anchor="middle" 
                              font-family="Arial, sans-serif" font-size="9" fill="#6c757d">
                            (This App)
                        </text>
                    </g>

                    <!-- PACS Interfaces (C-ECHO, C-FIND, C-STORE) -->
                    <g id="pacs-interfaces">
                        <rect x="${interfacesX}" y="${centerY - 100}" width="${interfacesWidth}" height="200" 
                              fill="white" stroke="#007bff" stroke-width="2" rx="10" />
                        <text x="${interfacesX + interfacesWidth/2}" y="${centerY - 70}" text-anchor="middle" 
                              font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#007bff">
                            PACS Interfaces
                        </text>
                        
                        <!-- C-ECHO -->
                        <rect x="${interfacesX + 25}" y="${centerY - 50}" width="100" height="30" 
                              fill="#e3f2fd" stroke="#1976d2" stroke-width="1" rx="5" />
                        <text x="${interfacesX + interfacesWidth/2}" y="${centerY - 30}" text-anchor="middle" 
                              font-family="Arial, sans-serif" font-size="11" fill="#1976d2">
                            C-ECHO: ${currentPacs.aet_echo || 'N/A'}
                        </text>
                        
                        <!-- C-FIND -->
                        <rect x="${interfacesX + 25}" y="${centerY - 10}" width="100" height="30" 
                              fill="#e8f5e8" stroke="#388e3c" stroke-width="1" rx="5" />
                        <text x="${interfacesX + interfacesWidth/2}" y="${centerY + 10}" text-anchor="middle" 
                              font-family="Arial, sans-serif" font-size="11" fill="#388e3c">
                            C-FIND: ${currentPacs.aet_find || 'N/A'}
                        </text>
                        
                        <!-- C-STORE -->
                        <rect x="${interfacesX + 25}" y="${centerY + 30}" width="100" height="30" 
                              fill="#fff3e0" stroke="#f57c00" stroke-width="1" rx="5" />
                        <text x="${interfacesX + interfacesWidth/2}" y="${centerY + 50}" text-anchor="middle" 
                              font-family="Arial, sans-serif" font-size="11" fill="#f57c00">
                            C-STORE: ${currentPacs.aet_store || 'N/A'}
                        </text>
                        
                        <!-- Arrows from App to PACS interfaces -->
                        <line x1="${appX + appWidth}" y1="${centerY - 20}" 
                              x2="${interfacesX}" y2="${centerY - 35}" 
                              stroke="#1976d2" stroke-width="2" marker-end="url(#arrowhead-blue)" />
                        <line x1="${appX + appWidth}" y1="${centerY + 5}" 
                              x2="${interfacesX}" y2="${centerY + 5}" 
                              stroke="#388e3c" stroke-width="2" marker-end="url(#arrowhead-green)" />
                        <line x1="${appX + appWidth}" y1="${centerY + 30}" 
                              x2="${interfacesX}" y2="${centerY + 45}" 
                              stroke="#f57c00" stroke-width="2" marker-end="url(#arrowhead-orange)" />
                        
                        <!-- Arrows from PACS interfaces to PACS -->
                        <line x1="${interfacesX + interfacesWidth}" y1="${centerY - 35}" 
                              x2="${pacsX}" y2="${centerY - 30}" 
                              stroke="#1976d2" stroke-width="2" marker-end="url(#arrowhead-blue)" />
                        <line x1="${interfacesX + interfacesWidth}" y1="${centerY + 5}" 
                              x2="${pacsX}" y2="${centerY - 10}" 
                              stroke="#388e3c" stroke-width="2" marker-end="url(#arrowhead-green)" />
                        <line x1="${interfacesX + interfacesWidth}" y1="${centerY + 45}" 
                              x2="${pacsX}" y2="${centerY + 10}" 
                              stroke="#f57c00" stroke-width="2" marker-end="url(#arrowhead-orange)" />
                    </g>
                    
                    <!-- Center PACS box -->
                    <g id="center-pacs">
                        <rect x="${pacsX}" y="${centerY - pacsBoxHeight/2}" 
                              width="${pacsBoxWidth}" height="${pacsBoxHeight}" 
                              fill="white" stroke="${currentPacs.environment === 'test' ? '#198754' : '#6f42c1'}" 
                              stroke-width="3" rx="10" />
                        
                        <text x="${pacsX + pacsBoxWidth/2}" y="${centerY - 30}" text-anchor="middle" 
                              font-family="Arial, sans-serif" font-size="16" font-weight="bold" 
                              fill="${currentPacs.environment === 'test' ? '#198754' : '#6f42c1'}">
                            ${currentPacs.name}
                        </text>
                        
                        <text x="${pacsX + pacsBoxWidth/2}" y="${centerY - 10}" text-anchor="middle" 
                              font-family="Arial, sans-serif" font-size="12" fill="#666">
                            ${currentPacs.host}:${currentPacs.port}
                        </text>
                        
                        <text x="${pacsX + pacsBoxWidth/2}" y="${centerY + 10}" text-anchor="middle" 
                              font-family="Arial, sans-serif" font-size="12" fill="#666">
                            AEC: ${currentPacs.aec}
                        </text>
                        
                        <text x="${pacsX + pacsBoxWidth/2}" y="${centerY + 30}" text-anchor="middle" 
                              font-family="Arial, sans-serif" font-size="10" 
                              fill="${currentPacs.environment === 'test' ? '#198754' : '#6f42c1'}">
                            ${currentPacs.environment.toUpperCase()} ENVIRONMENT
                        </text>
                    </g>
                    
                    <!-- Outbound AEs Container -->
                    <g id="outbound-aes-container">
                        <rect x="${outboundAEX}" y="${outboundAEY}" width="${outboundAEWidth}" height="${outboundAEHeight}"
                              fill="white" stroke="#007bff" stroke-width="2" rx="10" />
                        <text x="${outboundAEX + outboundAEWidth / 2}" y="${outboundAEY + 30}" text-anchor="middle"
                              font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#007bff">
                            Outbound AEs
                        </text>
                    </g>
                    
                    <!-- Right side C-MOVE routes -->
                    <g id="right-routes">
                        ${moveRoutes.map((route, index) => {
                            const routeY = centerY - 80 + (index * 80);
                            const destColor = route.destPacs.environment === 'test' ? '#198754' : '#6f42c1';
                            const aeBoxX = rightStartX;
                            const pacsBoxX = rightStartX + 140;
                            
                            return `
                                <!-- Connection line from center PACS to C-MOVE AE -->
                                <line x1="${pacsX + pacsBoxWidth}" y1="${centerY}" 
                                      x2="${aeBoxX}" y2="${routeY + 15}" 
                                      stroke="#666" stroke-width="2" marker-end="url(#arrowhead)" />
                                
                                <!-- C-MOVE AE box -->
                                <rect x="${aeBoxX}" y="${routeY}" width="120" height="30" 
                                      fill="white" stroke="${destColor}" stroke-width="2" rx="5" />
                                <text x="${aeBoxX + 60}" y="${routeY + 20}" text-anchor="middle" 
                                      font-family="Arial, sans-serif" font-size="11" fill="${destColor}">
                                    C-MOVE: ${route.aeTitle}
                                </text>
                                
                                <!-- Arrow from C-MOVE AE to destination PACS -->
                                <line x1="${aeBoxX + 120}" y1="${routeY + 15}" 
                                      x2="${pacsBoxX}" y2="${routeY + 15}" 
                                      stroke="${destColor}" stroke-width="2" marker-end="url(#arrowhead)" />
                                
                                <!-- Destination PACS -->
                                <rect x="${pacsBoxX}" y="${routeY}" width="120" height="30" 
                                      fill="white" stroke="${destColor}" stroke-width="2" rx="5" />
                                <text x="${pacsBoxX + 60}" y="${routeY + 20}" text-anchor="middle" 
                                      font-family="Arial, sans-serif" font-size="11" fill="${destColor}">
                                    ${route.destPacs.name}
                                </text>
                            `;
                        }).join('')}
                        
                        ${moveRoutes.length === 0 ? `
                            <text x="${rightStartX + 60}" y="${centerY}" text-anchor="middle" 
                                  font-family="Arial, sans-serif" font-size="14" fill="#999">
                                No C-MOVE routes configured
                            </text>
                        ` : ''}
                    </g>
                    
                    <!-- Arrow marker definitions -->
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                                refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#666" />
                        </marker>
                        <marker id="arrowhead-blue" markerWidth="10" markerHeight="7" 
                                refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#1976d2" />
                        </marker>
                        <marker id="arrowhead-green" markerWidth="10" markerHeight="7" 
                                refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#388e3c" />
                        </marker>
                        <marker id="arrowhead-orange" markerWidth="10" markerHeight="7" 
                                refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#f57c00" />
                        </marker>
                    </defs>
                    
                    <!-- Legend -->
                    <g id="legend">
                        <rect x="20" y="20" width="220" height="100" fill="white" stroke="#ddd" stroke-width="1" rx="5" />
                        <text x="30" y="40" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#333">
                            Legend:
                        </text>
                        <text x="30" y="60" font-family="Arial, sans-serif" font-size="10" fill="#333">
                            • Green = Test Environment
                        </text>
                        <text x="30" y="80" font-family="Arial, sans-serif" font-size="10" fill="#333">
                            • Purple = Production Environment
                        </text>
                        <text x="30" y="100" font-family="Arial, sans-serif" font-size="10" fill="#333">
                            • Gray = DICOM Fabricator App
                        </text>
                    </g>
                </svg>
            `;
            
            document.getElementById('pacsDiagramContent').innerHTML = svg;
        }
    </script>
{% endblock %}