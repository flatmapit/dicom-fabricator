{% extends "base.html" %}

{% block title %}PACS - DICOM Fabricator{% endblock %}

{% block head %}
<!-- Custom table implementation - no external dependencies -->
<style>
/* Custom table styling */
.custom-table {
    width: 100%;
    border-collapse: collapse;
}

.custom-table th,
.custom-table td {
    padding: 8px 12px;
    text-align: left;
    border-bottom: 1px solid #dee2e6;
}

.custom-table th {
    background-color: #f8f9fa;
    font-weight: 600;
    cursor: pointer;
    user-select: none;
    position: relative;
    padding-right: 25px;
}

.custom-table th.sortable::after {
    content: "‚áÖ";
    position: absolute;
    right: 8px;
    opacity: 0.5;
    font-size: 0.8rem;
}

.custom-table th.sortable.sort-asc::after {
    content: "‚Üë";
    opacity: 1;
}

.custom-table th.sortable.sort-desc::after {
    content: "‚Üì";
    opacity: 1;
}

.custom-table tbody tr:hover {
    background-color: rgba(0,0,0,.075);
}

/* Ensure table responsiveness */
.table-responsive {
    overflow-x: auto;
}

/* Status indicators */
.status-indicator {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 8px;
}

.status-online {
    background-color: #28a745;
}

.status-offline {
    background-color: #dc3545;
}

.status-unknown {
    background-color: #ffc107;
}
</style>

<script>
// Custom table implementation
class CustomTable {
    constructor(selector, options = {}) {
        this.table = document.querySelector(selector);
        this.options = options;
        this.data = [];
        this.currentSort = { column: null, direction: 'asc' };
        
        if (this.table) {
            this.init();
        }
    }
    
    init() {
        // Add custom table class
        this.table.classList.add('custom-table');
        
        // Make headers sortable
        const headers = this.table.querySelectorAll('th');
        headers.forEach((header, index) => {
            if (header.textContent.trim() !== '') {
                header.classList.add('sortable');
                header.addEventListener('click', () => this.sortByColumn(index));
            }
        });
    }
    
    sortByColumn(columnIndex) {
        const headers = this.table.querySelectorAll('th');
        const header = headers[columnIndex];
        
        // Clear previous sort indicators
        headers.forEach(h => {
            h.classList.remove('sort-asc', 'sort-desc');
        });
        
        // Determine sort direction
        if (this.currentSort.column === columnIndex) {
            this.currentSort.direction = this.currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
            this.currentSort.column = columnIndex;
            this.currentSort.direction = 'asc';
        }
        
        // Add sort indicator
        header.classList.add(`sort-${this.currentSort.direction}`);
        
        // Sort the table
        this.sortTable(columnIndex, this.currentSort.direction);
    }
    
    sortTable(columnIndex, direction) {
        const tbody = this.table.querySelector('tbody');
        if (!tbody) return;
        
        const rows = Array.from(tbody.querySelectorAll('tr'));
        
        rows.sort((a, b) => {
            const aValue = a.cells[columnIndex]?.textContent.trim() || '';
            const bValue = b.cells[columnIndex]?.textContent.trim() || '';
            
            // Try to convert to numbers for numeric sorting
            const aNum = parseFloat(aValue);
            const bNum = parseFloat(bValue);
            
            if (!isNaN(aNum) && !isNaN(bNum)) {
                return direction === 'asc' ? aNum - bNum : bNum - aNum;
            }
            
            // String sorting
            if (direction === 'asc') {
                return aValue.localeCompare(bValue);
            } else {
                return bValue.localeCompare(aValue);
            }
        });
        
        // Reorder rows
        rows.forEach(row => tbody.appendChild(row));
    }
    
    setData(data) {
        this.data = data;
        // This method can be extended to populate the table with data
        console.log('Table data set:', data.length, 'rows');
    }
    
    refresh() {
        // Refresh the table display
        console.log('Table refreshed');
    }
    
    destroy() {
        // Clean up event listeners
        const headers = this.table.querySelectorAll('th');
        headers.forEach(header => {
            header.classList.remove('sortable', 'sort-asc', 'sort-desc');
        });
        this.table.classList.remove('custom-table');
    }
}

// Global table instance
let pacsTable = null;

// Initialize table when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing custom table implementation');
    
    // Initialize the table
    const tableElement = document.querySelector('#pacsTable');
    if (tableElement) {
        pacsTable = new CustomTable('#pacsTable');
        console.log('Custom table initialized successfully');
    }
    
    // Load PACS configurations
    loadPacsConfigurations();
});
</script>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-server"></i> PACS</h2>
        <p class="text-muted">Manage PACS server configurations for sending and querying DICOM studies</p>
    </div>
</div>


        <!-- Actions -->
        <div class="row mb-3">
            <div class="col-12">
                <button class="btn btn-success" onclick="showCreateModal()">
                    <i class="fas fa-plus"></i> Add New PACS
                </button>
                <button class="btn btn-outline-secondary ms-2" onclick="refreshPacsTable()" 
                        data-bs-toggle="tooltip" title="Refresh PACS configurations">
                    <i class="fas fa-sync"></i> Refresh
                </button>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-bolt"></i> Quick Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="d-grid">
                                    <a href="/query-pacs" class="btn btn-primary btn-lg">
                                        <i class="fas fa-search"></i> Query PACS Studies
                                    </a>
                                </div>
                                <p class="text-muted small mt-2">Search and query DICOM studies on PACS servers with advanced filtering</p>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="d-grid">
                                    <a href="/generator" class="btn btn-success btn-lg">
                                        <i class="fas fa-file-medical"></i> Generate & Send Studies
                                    </a>
                                </div>
                                <p class="text-muted small mt-2">Create synthetic DICOM studies and send them to PACS servers</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PACS Configurations Table -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-list"></i> PACS Configurations</h5>
                    </div>
                    <div class="card-body">
                        <div id="pacsTableContainer">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <div class="mt-2">Loading PACS configurations...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create/Edit PACS Modal -->
    <div class="modal fade" id="pacsConfigModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="pacsModalTitle">Add New PACS Configuration</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="pacsConfigForm">
                        <input type="hidden" id="configId" name="configId">
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="configName" class="form-label">Name *</label>
                                    <input type="text" class="form-control" id="configName" name="name" required>
                                    <div class="form-text">Descriptive name for this PACS</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="configHost" class="form-label">Host *</label>
                                    <input type="text" class="form-control" id="configHost" name="host" required>
                                    <div class="form-text">IP address or hostname</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="configPort" class="form-label">Port *</label>
                                    <input type="number" class="form-control" id="configPort" name="port" min="1" max="65535" required>
                                    <div class="form-text">DICOM port (typically 4242)</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="configAET" class="form-label">Our AET *</label>
                                    <input type="text" class="form-control" id="configAET" name="aet" maxlength="16" required>
                                    <div class="form-text">Our Application Entity Title</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="configAEC" class="form-label">PACS AEC *</label>
                                    <input type="text" class="form-control" id="configAEC" name="aec" maxlength="16" required>
                                    <div class="form-text">Called Application Entity Title</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Options</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="configDefault" name="is_default">
                                        <label class="form-check-label" for="configDefault">
                                            Set as default PACS
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="configActive" name="is_active" checked>
                                        <label class="form-check-label" for="configActive">
                                            Active
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="configDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="configDescription" name="description" rows="2"></textarea>
                            <div class="form-text">Optional description or notes</div>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>AET/AEC Info:</strong> Application Entity Titles are typically 1-16 characters, 
                            alphanumeric plus some symbols. Common values: DICOMFAB, ORTHANC, TESTPACS.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="savePacsConfig()">
                        <i class="fas fa-save"></i> <span id="saveButtonText">Save Configuration</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Connection Modal -->
    <div class="modal fade" id="testConnectionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Test PACS Connection</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="testConnectionContent">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Testing connection...</span>
                            </div>
                            <div class="mt-2">Testing connection...</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let queryResultsTable;
        let currentEditId = null;
        let queryResults = [];

        async function loadPacsConfigurations() {
            try {
                const response = await fetch('/api/pacs/configs');
                const data = await response.json();
                
                if (data.success) {
                    displayPacsTable(data.configs);
                } else {
                    document.getElementById('pacsTableContainer').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i> Error loading PACS configurations: ${data.error}
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('pacsTableContainer').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i> Network error loading PACS configurations
                    </div>
                `;
            }
        }

        function displayPacsTable(configs) {
            if (configs.length === 0) {
                document.getElementById('pacsTableContainer').innerHTML = `
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-server fa-3x mb-3"></i>
                        <h5>No PACS Configurations</h5>
                        <p>Click "Add New PACS" to create your first configuration</p>
                    </div>
                `;
                return;
            }

            const tableHtml = `
                <div class="table-responsive" style="max-width: 95vw;">
                    <table id="pacsTable" class="table table-striped table-hover table-sm">
                        <thead>
                            <tr>
                                <th style="width: 15%;">Name</th>
                                <th style="width: 20%;">Host:Port</th>
                                <th style="width: 10%;">Our AET</th>
                                <th style="width: 10%;">PACS AEC</th>
                                <th style="width: 15%;">Description</th>
                                <th style="width: 8%;">Status</th>
                                <th style="width: 8%;">Default</th>
                                <th style="width: 10%;">Last Tested</th>
                                <th style="width: 14%;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${configs.map(config => {
                                const testStatusBadge = config.test_status === 'success' ? 
                                    '<span class="badge bg-success"><i class="fas fa-check"></i> Pass</span>' :
                                    config.test_status === 'failed' ?
                                    '<span class="badge bg-danger"><i class="fas fa-times"></i> Fail</span>' :
                                    '<span class="badge bg-secondary"><i class="fas fa-question"></i> Unknown</span>';
                                
                                const lastTested = config.last_tested ? 
                                    new Date(config.last_tested).toLocaleString() : 
                                    'Never';
                                
                                return `
                                    <tr>
                                        <td>
                                            <strong>${config.name}</strong>
                                            ${config.is_active ? '' : '<br><small class="text-muted">(Inactive)</small>'}
                                        </td>
                                        <td><code>${config.host}:${config.port}</code></td>
                                        <td><code>${config.aet}</code></td>
                                        <td><code>${config.aec}</code></td>
                                        <td>
                                            <div class="text-truncate" style="max-width: 150px;" title="${config.description || ''}">
                                                ${config.description || '-'}
                                            </div>
                                        </td>
                                        <td>${testStatusBadge}</td>
                                        <td>
                                            ${config.is_default ? '<span class="badge bg-warning"><i class="fas fa-star"></i> Default</span>' : '-'}
                                        </td>
                                        <td>
                                            <small>${lastTested}</small>
                                            ${config.test_message ? `<br><small class="text-muted" title="${config.test_message}">üìù</small>` : ''}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button class="btn btn-outline-info" onclick="testConnection('${config.id}')" 
                                                        data-bs-toggle="tooltip" title="Test PACS connection">
                                                    <i class="fas fa-sync-alt"></i>
                                                </button>
                                                <button class="btn btn-outline-primary" onclick="editConfig('${config.id}')" 
                                                        data-bs-toggle="tooltip" title="Edit configuration">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-outline-danger" onclick="deleteConfig('${config.id}', '${config.name}')" 
                                                        data-bs-toggle="tooltip" title="Delete configuration">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('pacsTableContainer').innerHTML = tableHtml;

                    // Initialize the custom table
        if (pacsTable) {
            pacsTable.setData(configs);
            console.log('Custom table data set successfully');
        } else {
            console.warn('Custom table instance not initialized, cannot set data.');
        }
    }

    // Add event listeners and initialization
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });
        
        // Start automatic PACS testing after initial load
        setTimeout(() => {
            testAllPacsConfigurations();
        }, 1000);
    });

        function showCreateModal() {
            currentEditId = null;
            document.getElementById('pacsModalTitle').textContent = 'Add New PACS Configuration';
            document.getElementById('saveButtonText').textContent = 'Save Configuration';
            document.getElementById('pacsConfigForm').reset();
            document.getElementById('configActive').checked = true;
            
            const modal = new bootstrap.Modal(document.getElementById('pacsConfigModal'));
            modal.show();
        }

        async function editConfig(configId) {
            try {
                const response = await fetch(`/api/pacs/configs/${configId}`);
                const data = await response.json();
                
                if (data.success) {
                    currentEditId = configId;
                    const config = data.config;
                    
                    document.getElementById('pacsModalTitle').textContent = 'Edit PACS Configuration';
                    document.getElementById('saveButtonText').textContent = 'Update Configuration';
                    
                    document.getElementById('configName').value = config.name;
                    document.getElementById('configHost').value = config.host;
                    document.getElementById('configPort').value = config.port;
                    document.getElementById('configAET').value = config.aet;
                    document.getElementById('configAEC').value = config.aec;
                    document.getElementById('configDescription').value = config.description || '';
                    document.getElementById('configDefault').checked = config.is_default;
                    document.getElementById('configActive').checked = config.is_active;
                    
                    const modal = new bootstrap.Modal(document.getElementById('pacsConfigModal'));
                    modal.show();
                } else {
                    alert('Error loading configuration: ' + data.error);
                }
            } catch (error) {
                alert('Network error loading configuration');
            }
        }

        async function savePacsConfig() {
            const form = document.getElementById('pacsConfigForm');
            const formData = new FormData(form);
            
            const configData = {
                name: formData.get('name'),
                host: formData.get('host'),
                port: parseInt(formData.get('port')),
                aet: formData.get('aet'),
                aec: formData.get('aec'),
                description: formData.get('description'),
                is_default: document.getElementById('configDefault').checked,
                is_active: document.getElementById('configActive').checked
            };

            try {
                const url = currentEditId ? `/api/pacs/configs/${currentEditId}` : '/api/pacs/configs';
                const method = currentEditId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(configData)
                });

                const data = await response.json();

                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('pacsConfigModal')).hide();
                    loadPacsConfigurations();
                } else {
                    alert('Error saving configuration: ' + data.error);
                }
            } catch (error) {
                alert('Network error saving configuration');
            }
        }

        async function deleteConfig(configId, configName) {
            if (!confirm(`Are you sure you want to delete the PACS configuration "${configName}"?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/pacs/configs/${configId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    loadPacsConfigurations();
                } else {
                    alert('Error deleting configuration: ' + data.error);
                }
            } catch (error) {
                alert('Network error deleting configuration');
            }
        }


        function refreshPacsTable() {
            loadPacsConfigurations();
        }


        async function testAllPacsConfigurations() {
            try {
                // Get all PACS configurations
                const response = await fetch('/api/pacs/configs');
                const data = await response.json();
                
                if (data.success && data.configs.length > 0) {
                    console.log(`Starting automatic testing of ${data.configs.length} PACS configurations...`);
                    
                    // Test each configuration with a delay to avoid overwhelming the network
                    for (let i = 0; i < data.configs.length; i++) {
                        const config = data.configs[i];
                        
                        // Only test active configurations
                        if (config.is_active) {
                            console.log(`Testing PACS: ${config.name}`);
                            
                            // Update UI to show testing in progress
                            updatePacsTestingStatus(config.id, 'testing');
                            
                            try {
                                await testConnection(config.id, false); // false = don't show modal
                                
                                // Add delay between tests to prevent overwhelming the server
                                if (i < data.configs.length - 1) {
                                    await new Promise(resolve => setTimeout(resolve, 2000));
                                }
                            } catch (error) {
                                console.error(`Error testing PACS ${config.name}:`, error);
                            }
                        }
                    }
                    
                    console.log('Automatic PACS testing completed');
                    
                    // Refresh table after all tests
                    loadPacsConfigurations();
                }
            } catch (error) {
                console.error('Error during automatic PACS testing:', error);
            }
        }

        function updatePacsTestingStatus(configId, status) {
            // Find the table row for this config and update the status badge
            const table = document.getElementById('pacsTable');
            if (!table) return;
            
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const testButton = row.querySelector(`button[onclick*="${configId}"]`);
                if (testButton) {
                    const statusCell = row.cells[5]; // Status column
                    if (statusCell) {
                        if (status === 'testing') {
                            statusCell.innerHTML = '<span class="badge bg-warning"><i class="fas fa-spinner fa-spin"></i> Testing</span>';
                        }
                    }
                }
            });
        }

        async function testConnection(configId, showModal = true) {
            if (showModal) {
                const modal = new bootstrap.Modal(document.getElementById('testConnectionModal'));
                document.getElementById('testConnectionContent').innerHTML = `
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Testing connection...</span>
                        </div>
                        <div class="mt-2">Testing connection...</div>
                    </div>
                `;
                modal.show();
            }

            try {
                const response = await fetch(`/api/pacs/configs/${configId}/test`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (showModal) {
                    if (data.success) {
                        document.getElementById('testConnectionContent').innerHTML = `
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle"></i> <strong>Connection Successful!</strong><br>
                                ${data.message}
                            </div>
                            ${data.output ? `<div class="mt-3"><h6>Output:</h6><pre class="bg-light p-2 rounded"><code>${data.output}</code></pre></div>` : ''}
                        `;
                    } else {
                        document.getElementById('testConnectionContent').innerHTML = `
                            <div class="alert alert-danger">
                                <i class="fas fa-times-circle"></i> <strong>Connection Failed!</strong><br>
                                ${data.error}
                            </div>
                        `;
                    }
                }

                // Always refresh the table to show updated test status
                if (showModal) {
                    // Small delay before refreshing to let the test result persist in backend
                    setTimeout(() => {
                        loadPacsConfigurations();
                    }, 1000);
                }

                return data.success;

            } catch (error) {
                if (showModal) {
                    document.getElementById('testConnectionContent').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i> <strong>Network Error!</strong><br>
                            Could not test connection: ${error.message}
                        </div>
                    `;
                }
                return false;
            }
        }
    </script>
{% endblock %}